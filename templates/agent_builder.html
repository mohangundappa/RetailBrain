{% extends "base.html" %}

{% block title %}Agent Builder - Staples Brain{% endblock %}

{% block additional_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/agent_builder.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Best Practices Guide -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center bg-info text-white">
          <h5 class="mb-0">Agent Builder Best Practices</h5>
          <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#bestPracticesGuide" aria-expanded="false">
            <i class="bi bi-info-circle"></i> Show/Hide Guide
          </button>
        </div>
        <div class="collapse" id="bestPracticesGuide">
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <h6><i class="bi bi-check-circle"></i> Intent Management</h6>
                <ul class="small">
                  <li><strong>Keep intents specific</strong> to this agent's domain</li>
                  <li>Avoid overlap with other agents' intents</li>
                  <li>Name intents clearly with action_object format (e.g., check_status)</li>
                </ul>
              </div>
              <div class="col-md-4">
                <h6><i class="bi bi-diagram-3"></i> Component Flow</h6>
                <ul class="small">
                  <li>Start with an <strong>Intent Classifier</strong> to categorize requests</li>
                  <li>Add an <strong>Entity Extractor</strong> to identify key information</li>
                  <li>Connect to an <strong>LLM Model</strong> for processing</li>
                  <li>End with a <strong>Response Formatter</strong> for structured output</li>
                </ul>
              </div>
              <div class="col-md-4">
                <h6><i class="bi bi-gear"></i> Testing Tips</h6>
                <ul class="small">
                  <li>Test with varied customer inputs</li>
                  <li>Include edge cases (missing info, complex requests)</li>
                  <li>Verify response format and helpfulness</li>
                  <li>Check how it handles out-of-scope requests</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Agent Management -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Manage Existing Agents</h5>
          <div>
            <a href="/agent-management-docs" class="btn btn-sm btn-outline-info me-2" target="_blank">
              <i class="bi bi-question-circle"></i> View Documentation
            </a>
            <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#existingAgentsPanel" aria-expanded="false">
              <i class="bi bi-list-ul"></i> Show/Hide Agents
            </button>
          </div>
        </div>
        <div class="collapse" id="existingAgentsPanel">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="existing-agents-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Components</th>
                    <th>Last Updated</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="existing-agents-list">
                  <tr>
                    <td colspan="5" class="text-center">
                      <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                      Loading agents...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="d-flex justify-content-end mt-2">
              <a href="{{ url_for('agent_wizard') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Create New Agent
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row">
    <!-- Sidebar with component palette -->
    <div class="col-md-3 sidebar" id="component-palette">
      <div class="card">
        <div class="card-header">
          <h5>Components</h5>
        </div>
        <div class="card-body">
          <div class="accordion" id="componentsAccordion">
            <!-- Prompt Templates -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingPrompts">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePrompts" aria-expanded="true" aria-controls="collapsePrompts">
                  Prompt Templates
                </button>
              </h2>
              <div id="collapsePrompts" class="accordion-collapse collapse show" aria-labelledby="headingPrompts" data-bs-parent="#componentsAccordion">
                <div class="accordion-body component-list">
                  <div class="draggable-component" data-component-type="prompt" data-component-template="intent_classifier">
                    <div class="component-icon">üìù</div>
                    <div class="component-name">Intent Classifier</div>
                  </div>
                  <div class="draggable-component" data-component-type="prompt" data-component-template="entity_extractor">
                    <div class="component-icon">üîç</div>
                    <div class="component-name">Entity Extractor</div>
                  </div>
                  <div class="draggable-component" data-component-type="prompt" data-component-template="custom_prompt">
                    <div class="component-icon">‚úèÔ∏è</div>
                    <div class="component-name">Custom Prompt</div>
                  </div>
                </div>
              </div>
            </div>
            <!-- LLM Models -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingLLMs">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLLMs" aria-expanded="false" aria-controls="collapseLLMs">
                  LLM Models
                </button>
              </h2>
              <div id="collapseLLMs" class="accordion-collapse collapse" aria-labelledby="headingLLMs" data-bs-parent="#componentsAccordion">
                <div class="accordion-body component-list">
                  <div class="draggable-component" data-component-type="llm" data-component-template="openai_gpt4">
                    <div class="component-icon">üß†</div>
                    <div class="component-name">OpenAI GPT-4</div>
                  </div>
                  <div class="draggable-component" data-component-type="llm" data-component-template="perplexity">
                    <div class="component-icon">üîÆ</div>
                    <div class="component-name">Perplexity</div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Tools -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingTools">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTools" aria-expanded="false" aria-controls="collapseTools">
                  Tools
                </button>
              </h2>
              <div id="collapseTools" class="accordion-collapse collapse" aria-labelledby="headingTools" data-bs-parent="#componentsAccordion">
                <div class="accordion-body component-list">
                  <div class="draggable-component" data-component-type="tool" data-component-template="database_query">
                    <div class="component-icon">üóÉÔ∏è</div>
                    <div class="component-name">Database Query</div>
                  </div>
                  <div class="draggable-component" data-component-type="tool" data-component-template="api_caller">
                    <div class="component-icon">üåê</div>
                    <div class="component-name">API Caller</div>
                  </div>
                  <div class="draggable-component" data-component-type="tool" data-component-template="web_search">
                    <div class="component-icon">üîé</div>
                    <div class="component-name">Web Search</div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Output Handlers -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingOutputs">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOutputs" aria-expanded="false" aria-controls="collapseOutputs">
                  Output Handlers
                </button>
              </h2>
              <div id="collapseOutputs" class="accordion-collapse collapse" aria-labelledby="headingOutputs" data-bs-parent="#componentsAccordion">
                <div class="accordion-body component-list">
                  <div class="draggable-component" data-component-type="output" data-component-template="json_formatter">
                    <div class="component-icon">üìä</div>
                    <div class="component-name">JSON Formatter</div>
                  </div>
                  <div class="draggable-component" data-component-type="output" data-component-template="response_formatter">
                    <div class="component-icon">üí¨</div>
                    <div class="component-name">Response Formatter</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Main canvas area -->
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 id="current-agent-name">New Agent</h5>
          <div>
            <button id="save-agent" class="btn btn-primary btn-sm">Save Agent</button>
            <button id="test-agent" class="btn btn-success btn-sm">Test Agent</button>
          </div>
        </div>
        <div class="card-body">
          <div id="agent-canvas" class="agent-canvas">
            <!-- Canvas for drag and drop agent building -->
            <div id="canvas-help" class="text-center p-5 text-muted" style="pointer-events: none;">
              <i class="bi bi-arrows-move" style="font-size: 3rem;"></i>
              <h4>Getting Started</h4>
              <p>Drag components from the left panel to this canvas</p>
              <div class="row mt-4">
                <div class="col">
                  <div class="border rounded p-2 mb-2">1. Start with Intent Classifier</div>
                  <i class="bi bi-arrow-down"></i>
                </div>
                <div class="col">
                  <div class="border rounded p-2 mb-2">2. Add Entity Extractor</div>
                  <i class="bi bi-arrow-down"></i>
                </div>
              </div>
              <div class="row mt-2">
                <div class="col">
                  <div class="border rounded p-2 mb-2">3. Connect to LLM Model</div>
                  <i class="bi bi-arrow-down"></i>
                </div>
                <div class="col">
                  <div class="border rounded p-2 mb-2">4. End with Response Formatter</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Properties panel -->
    <div class="col-md-3">
      <div class="card">
        <div class="card-header">
          <h5>Properties</h5>
        </div>
        <div class="card-body">
          <div id="agent-properties" class="p-0">
            <!-- Agent properties form -->
            <form id="agent-form">
              <div class="mb-3">
                <label for="agent-name" class="form-label">Agent Name</label>
                <input type="text" class="form-control" id="agent-name" placeholder="Enter agent name">
              </div>
              <div class="mb-3">
                <label for="agent-description" class="form-label">Description</label>
                <textarea class="form-control" id="agent-description" rows="3" placeholder="Describe what this agent does"></textarea>
              </div>
            </form>
          </div>
          <div id="component-properties" class="d-none">
            <!-- Component properties will be dynamically inserted here -->
            <div class="text-center text-muted p-4">
              Select a component to view its properties
            </div>
          </div>
        </div>
      </div>
      
      <!-- Test Console (initially hidden) -->
      <div class="card mt-3 d-none" id="test-console">
        <div class="card-header">
          <h5>Test Console</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label for="test-input" class="form-label">Test Input</label>
            <textarea class="form-control" id="test-input" rows="3" placeholder="Enter test input for your agent"></textarea>
          </div>
          <button id="run-test" class="btn btn-primary btn-sm">Run Test</button>
          <div class="mt-3">
            <label class="form-label">Output</label>
            <pre id="test-output" class="p-2 bg-dark text-light" style="height: 150px; overflow-y: auto;">Results will appear here</pre>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteAgentModal" tabindex="-1" aria-labelledby="deleteAgentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteAgentModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the agent <strong id="delete-agent-name">Agent Name</strong>?</p>
        <p class="text-danger"><i class="bi bi-exclamation-triangle"></i> This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-agent">Delete Agent</button>
      </div>
    </div>
  </div>
</div>

<!-- Component Templates (hidden) -->
<div id="component-templates" class="d-none">
  <!-- Intent Classifier Template -->
  <div id="template-intent_classifier">
    <div class="mb-3">
      <label class="form-label">Available Intents</label>
      <div class="form-text text-info mb-2">
        <i class="bi bi-info-circle"></i> Best Practice: Use specific, non-overlapping intents in action_object format
      </div>
      <textarea class="form-control component-config" data-config-key="available_intents" rows="4" placeholder="e.g., return_policy, initiate_return, check_status (comma-separated)"></textarea>
      <div class="mt-2 p-2 border rounded bg-light">
        <small class="text-muted">
          <strong>Examples for Return Processing Agent:</strong><br>
          return_policy, initiate_return, return_status, refund_timeline
        </small>
      </div>
    </div>
    <div class="mb-3">
      <label class="form-label">System Prompt</label>
      <div class="form-text text-info mb-2">
        <i class="bi bi-info-circle"></i> Describe the agent's role and how to classify inputs
      </div>
      <textarea class="form-control component-config" data-config-key="system_prompt" rows="6" placeholder="You are a specialized agent that handles... Classify the input into one of these categories..."></textarea>
      <div class="mt-2 p-2 border rounded bg-light">
        <small class="text-muted">
          <strong>Example:</strong><br>
          You are a return processing assistant for Staples. Classify the customer's query into one of these categories...
        </small>
      </div>
    </div>
    <div class="mb-3">
      <label class="form-label">Temperature</label>
      <input type="range" class="form-range component-config" data-config-key="temperature" min="0" max="1" step="0.1" value="0.3">
      <div class="d-flex justify-content-between">
        <small>Precise (0)</small>
        <small id="temperature-value">0.3</small>
        <small>Creative (1)</small>
      </div>
      <div class="form-text text-info">
        <i class="bi bi-lightbulb"></i> Tip: Use lower temperature (0.1-0.3) for more predictable classification
      </div>
    </div>
  </div>
  
  <!-- Entity Extractor Template -->
  <div id="template-entity_extractor">
    <div class="mb-3">
      <label class="form-label">Entity Types</label>
      <div class="form-text text-info mb-2">
        <i class="bi bi-info-circle"></i> List all data points your agent needs to extract from user inputs
      </div>
      <textarea class="form-control component-config" data-config-key="entity_types" rows="4" placeholder="e.g., order_number, product_id, purchase_date"></textarea>
      <div class="mt-2 p-2 border rounded bg-light">
        <small class="text-muted">
          <strong>Examples for Return Processing Agent:</strong><br>
          order_number, product_id, purchase_date, reason_for_return, return_method, receipt_available
        </small>
      </div>
    </div>
    <div class="mb-3">
      <label class="form-label">Extraction Prompt</label>
      <div class="form-text text-info mb-2">
        <i class="bi bi-info-circle"></i> Guide the LLM on how to identify each entity
      </div>
      <textarea class="form-control component-config" data-config-key="extraction_prompt" rows="6" placeholder="Extract key information from the user input..."></textarea>
      <div class="mt-2 p-2 border rounded bg-light">
        <small class="text-muted">
          <strong>Example:</strong><br>
          Extract key information from the customer's return-related query:<br>
          - order_number: The order number for the purchase<br>
          - product_id: Any product identifiers mentioned<br>
          - purchase_date: When the item was purchased
        </small>
      </div>
    </div>
    
    <div class="card mt-3 border-info mb-3">
      <div class="card-header bg-info text-white">
        <div class="form-check">
          <input class="form-check-input component-config" type="checkbox" id="use-entity-collection" data-config-key="use_entity_collection_framework" checked>
          <label class="form-check-label" for="use-entity-collection">
            <strong>Use Entity Collection Framework</strong>
          </label>
        </div>
      </div>
      <div class="card-body">
        <p class="small">The entity collection framework enables:</p>
        <ul class="small">
          <li>Form-like entity collection with validation</li>
          <li>Automatic follow-up questions for missing entities</li>
          <li>Regex validation for entity values</li>
          <li>User-friendly error messages</li>
          <li>Maximum attempt limits</li>
        </ul>
        
        <div class="mb-3">
          <label class="form-label">Validation Patterns (Regex)</label>
          <div class="form-text text-info mb-2">
            <i class="bi bi-info-circle"></i> Define regex patterns to validate each entity
          </div>
          <textarea class="form-control component-config" data-config-key="validation_patterns" rows="6" placeholder='{\n  "order_number": "^[A-Za-z0-9]{2,}-?[A-Za-z0-9]{2,}$",\n  "email": "^[\\w-\\.]+@([\\w-]+\\.)+[\\w-]{2,4}$"\n}'></textarea>
          <div class="form-text">JSON object mapping entity names to regex validation patterns</div>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Error Messages</label>
          <div class="form-text text-info mb-2">
            <i class="bi bi-info-circle"></i> Custom error messages when validation fails
          </div>
          <textarea class="form-control component-config" data-config-key="error_messages" rows="6" placeholder='{\n  "order_number": "Order numbers typically contain letters and numbers, like \'OD1234567\'.",\n  "email": "Please provide a valid email address."\n}'></textarea>
          <div class="form-text">JSON object mapping entity names to user-friendly error messages</div>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Maximum Attempts</label>
          <div class="form-text text-info mb-2">
            <i class="bi bi-info-circle"></i> How many times to ask for a valid entity before giving up
          </div>
          <input type="number" class="form-control component-config" data-config-key="max_attempts" min="1" max="5" value="3">
          <div class="form-text">Recommended: 3 attempts before transferring to human agent</div>
        </div>
      </div>
    </div>
    
    <div class="alert alert-warning mt-3">
      <i class="bi bi-exclamation-triangle"></i> <strong>Important:</strong> Ensure entity types listed above match those in the extraction prompt and validation patterns
    </div>
  </div>
  
  <!-- OpenAI Model Template -->
  <div id="template-openai_gpt4">
    <div class="mb-3">
      <label class="form-label">Model</label>
      <select class="form-select component-config" data-config-key="model_name">
        <option value="gpt-4o">GPT-4o</option>
        <option value="gpt-4-turbo">GPT-4 Turbo</option>
        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">Temperature</label>
      <input type="range" class="form-range component-config" data-config-key="temperature" min="0" max="1" step="0.1" value="0.3">
      <div class="d-flex justify-content-between">
        <small>Precise (0)</small>
        <small id="openai-temperature-value">0.3</small>
        <small>Creative (1)</small>
      </div>
    </div>
    <div class="mb-3">
      <label class="form-label">Max Tokens</label>
      <input type="number" class="form-control component-config" data-config-key="max_tokens" min="1" max="4000" value="1000">
    </div>
  </div>
  
  <!-- JSON Formatter Template -->
  <div id="template-json_formatter">
    <div class="mb-3">
      <label class="form-label">Output Schema</label>
      <div class="form-text text-info mb-2">
        <i class="bi bi-info-circle"></i> Define the structure of your agent's response data
      </div>
      <textarea class="form-control component-config" data-config-key="schema" rows="8" placeholder='{ "response": "string", "next_steps": ["string"], "data": { "key": "value" } }'></textarea>
      <div class="mt-2 p-2 border rounded bg-light">
        <small class="text-muted">
          <strong>Example for Return Processing:</strong><br>
          <code>{<br>
            &nbsp;&nbsp;"response": "string",<br>
            &nbsp;&nbsp;"next_steps": ["string"],<br>
            &nbsp;&nbsp;"return_id": "string",<br>
            &nbsp;&nbsp;"estimated_refund_days": "number",<br>
            &nbsp;&nbsp;"requires_followup": "boolean"<br>
          }</code>
        </small>
      </div>
    </div>
    <div class="form-check mb-3">
      <input class="form-check-input component-config" type="checkbox" data-config-key="enforce_schema" id="enforce-schema" checked>
      <label class="form-check-label" for="enforce-schema">
        Strictly enforce schema
      </label>
      <div class="form-text text-info">
        <i class="bi bi-shield-check"></i> Recommended: Keep this checked to ensure consistent outputs
      </div>
    </div>
    <div class="alert alert-info mt-3">
      <i class="bi bi-lightbulb"></i> <strong>Tip:</strong> Include a "response" field for customer-facing text and separate fields for structured data
    </div>
  </div>
</div>

<!-- Modal for connection configuration -->
<div class="modal fade" id="connection-modal" tabindex="-1" aria-labelledby="connectionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="connectionModalLabel">Configure Connection</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info mb-3">
          <i class="bi bi-info-circle-fill"></i> <strong>Connection Guide:</strong>
          <ul class="mb-0 small">
            <li>Connect components in the order they should process data (usually top to bottom)</li>
            <li>The standard flow is: Intent Classifier ‚Üí Entity Extractor ‚Üí LLM Model ‚Üí Response Formatter</li>
          </ul>
        </div>
        <form id="connection-form">
          <div class="mb-3">
            <label for="connection-type" class="form-label">Connection Type</label>
            <select class="form-select" id="connection-type">
              <option value="data">Data Flow</option>
              <option value="control">Control Flow</option>
            </select>
            <div class="form-text">
              <strong>Data Flow:</strong> Passes information between components<br>
              <strong>Control Flow:</strong> Determines execution path based on conditions
            </div>
          </div>
          <div class="mb-3">
            <label for="connection-description" class="form-label">Description</label>
            <input type="text" class="form-control" id="connection-description" placeholder="E.g., Intent to Entity Flow">
            <div class="form-text">
              Adding a clear description helps understand the purpose of each connection
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-connection">
          <i class="bi bi-link"></i> Save Connection
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsPlumb/2.15.6/js/jsplumb.min.js"></script>
<script src="{{ url_for('static', filename='js/agent_builder.js') }}"></script>
<script src="{{ url_for('static', filename='js/agent_management.js') }}"></script>
{% endblock %}