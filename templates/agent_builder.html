{% extends "base.html" %}

{% block title %}Agent Builder - Staples Brain{% endblock %}

{% block additional_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/agent_builder.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar with component palette -->
    <div class="col-md-3 sidebar" id="component-palette">
      <div class="card">
        <div class="card-header">
          <h5>Components</h5>
        </div>
        <div class="card-body">
          <div class="accordion" id="componentsAccordion">
            <!-- Prompt Templates -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingPrompts">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePrompts" aria-expanded="true" aria-controls="collapsePrompts">
                  Prompt Templates
                </button>
              </h2>
              <div id="collapsePrompts" class="accordion-collapse collapse show" aria-labelledby="headingPrompts" data-bs-parent="#componentsAccordion">
                <div class="accordion-body component-list">
                  <div class="draggable-component" data-component-type="prompt" data-component-template="intent_classifier">
                    <div class="component-icon">üìù</div>
                    <div class="component-name">Intent Classifier</div>
                  </div>
                  <div class="draggable-component" data-component-type="prompt" data-component-template="entity_extractor">
                    <div class="component-icon">üîç</div>
                    <div class="component-name">Entity Extractor</div>
                  </div>
                  <div class="draggable-component" data-component-type="prompt" data-component-template="custom_prompt">
                    <div class="component-icon">‚úèÔ∏è</div>
                    <div class="component-name">Custom Prompt</div>
                  </div>
                </div>
              </div>
            </div>
            <!-- LLM Models -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingLLMs">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLLMs" aria-expanded="false" aria-controls="collapseLLMs">
                  LLM Models
                </button>
              </h2>
              <div id="collapseLLMs" class="accordion-collapse collapse" aria-labelledby="headingLLMs" data-bs-parent="#componentsAccordion">
                <div class="accordion-body component-list">
                  <div class="draggable-component" data-component-type="llm" data-component-template="openai_gpt4">
                    <div class="component-icon">üß†</div>
                    <div class="component-name">OpenAI GPT-4</div>
                  </div>
                  <div class="draggable-component" data-component-type="llm" data-component-template="perplexity">
                    <div class="component-icon">üîÆ</div>
                    <div class="component-name">Perplexity</div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Tools -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingTools">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTools" aria-expanded="false" aria-controls="collapseTools">
                  Tools
                </button>
              </h2>
              <div id="collapseTools" class="accordion-collapse collapse" aria-labelledby="headingTools" data-bs-parent="#componentsAccordion">
                <div class="accordion-body component-list">
                  <div class="draggable-component" data-component-type="tool" data-component-template="database_query">
                    <div class="component-icon">üóÉÔ∏è</div>
                    <div class="component-name">Database Query</div>
                  </div>
                  <div class="draggable-component" data-component-type="tool" data-component-template="api_caller">
                    <div class="component-icon">üåê</div>
                    <div class="component-name">API Caller</div>
                  </div>
                  <div class="draggable-component" data-component-type="tool" data-component-template="web_search">
                    <div class="component-icon">üîé</div>
                    <div class="component-name">Web Search</div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Output Handlers -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingOutputs">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOutputs" aria-expanded="false" aria-controls="collapseOutputs">
                  Output Handlers
                </button>
              </h2>
              <div id="collapseOutputs" class="accordion-collapse collapse" aria-labelledby="headingOutputs" data-bs-parent="#componentsAccordion">
                <div class="accordion-body component-list">
                  <div class="draggable-component" data-component-type="output" data-component-template="json_formatter">
                    <div class="component-icon">üìä</div>
                    <div class="component-name">JSON Formatter</div>
                  </div>
                  <div class="draggable-component" data-component-type="output" data-component-template="response_formatter">
                    <div class="component-icon">üí¨</div>
                    <div class="component-name">Response Formatter</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Main canvas area -->
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 id="current-agent-name">New Agent</h5>
          <div>
            <button id="save-agent" class="btn btn-primary btn-sm">Save Agent</button>
            <button id="test-agent" class="btn btn-success btn-sm">Test Agent</button>
          </div>
        </div>
        <div class="card-body">
          <div id="agent-canvas" class="agent-canvas">
            <!-- Canvas for drag and drop agent building -->
          </div>
        </div>
      </div>
    </div>
    
    <!-- Properties panel -->
    <div class="col-md-3">
      <div class="card">
        <div class="card-header">
          <h5>Properties</h5>
        </div>
        <div class="card-body">
          <div id="agent-properties" class="p-0">
            <!-- Agent properties form -->
            <form id="agent-form">
              <div class="mb-3">
                <label for="agent-name" class="form-label">Agent Name</label>
                <input type="text" class="form-control" id="agent-name" placeholder="Enter agent name">
              </div>
              <div class="mb-3">
                <label for="agent-description" class="form-label">Description</label>
                <textarea class="form-control" id="agent-description" rows="3" placeholder="Describe what this agent does"></textarea>
              </div>
            </form>
          </div>
          <div id="component-properties" class="d-none">
            <!-- Component properties will be dynamically inserted here -->
            <div class="text-center text-muted p-4">
              Select a component to view its properties
            </div>
          </div>
        </div>
      </div>
      
      <!-- Test Console (initially hidden) -->
      <div class="card mt-3 d-none" id="test-console">
        <div class="card-header">
          <h5>Test Console</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label for="test-input" class="form-label">Test Input</label>
            <textarea class="form-control" id="test-input" rows="3" placeholder="Enter test input for your agent"></textarea>
          </div>
          <button id="run-test" class="btn btn-primary btn-sm">Run Test</button>
          <div class="mt-3">
            <label class="form-label">Output</label>
            <pre id="test-output" class="p-2 bg-dark text-light" style="height: 150px; overflow-y: auto;">Results will appear here</pre>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Component Templates (hidden) -->
<div id="component-templates" class="d-none">
  <!-- Intent Classifier Template -->
  <div id="template-intent_classifier">
    <div class="mb-3">
      <label class="form-label">Available Intents</label>
      <textarea class="form-control component-config" data-config-key="available_intents" rows="4" placeholder="Enter comma-separated intent list"></textarea>
    </div>
    <div class="mb-3">
      <label class="form-label">System Prompt</label>
      <textarea class="form-control component-config" data-config-key="system_prompt" rows="6" placeholder="System instructions for intent classification"></textarea>
    </div>
    <div class="mb-3">
      <label class="form-label">Temperature</label>
      <input type="range" class="form-range component-config" data-config-key="temperature" min="0" max="1" step="0.1" value="0.3">
      <div class="d-flex justify-content-between">
        <small>Precise (0)</small>
        <small id="temperature-value">0.3</small>
        <small>Creative (1)</small>
      </div>
    </div>
  </div>
  
  <!-- Entity Extractor Template -->
  <div id="template-entity_extractor">
    <div class="mb-3">
      <label class="form-label">Entity Types</label>
      <textarea class="form-control component-config" data-config-key="entity_types" rows="4" placeholder="Enter entity types to extract"></textarea>
    </div>
    <div class="mb-3">
      <label class="form-label">Extraction Prompt</label>
      <textarea class="form-control component-config" data-config-key="extraction_prompt" rows="6" placeholder="Instructions for entity extraction"></textarea>
    </div>
  </div>
  
  <!-- OpenAI Model Template -->
  <div id="template-openai_gpt4">
    <div class="mb-3">
      <label class="form-label">Model</label>
      <select class="form-select component-config" data-config-key="model_name">
        <option value="gpt-4o">GPT-4o</option>
        <option value="gpt-4-turbo">GPT-4 Turbo</option>
        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">Temperature</label>
      <input type="range" class="form-range component-config" data-config-key="temperature" min="0" max="1" step="0.1" value="0.3">
      <div class="d-flex justify-content-between">
        <small>Precise (0)</small>
        <small id="openai-temperature-value">0.3</small>
        <small>Creative (1)</small>
      </div>
    </div>
    <div class="mb-3">
      <label class="form-label">Max Tokens</label>
      <input type="number" class="form-control component-config" data-config-key="max_tokens" min="1" max="4000" value="1000">
    </div>
  </div>
  
  <!-- JSON Formatter Template -->
  <div id="template-json_formatter">
    <div class="mb-3">
      <label class="form-label">Output Schema</label>
      <textarea class="form-control component-config" data-config-key="schema" rows="8" placeholder="Enter JSON schema for output formatting"></textarea>
    </div>
    <div class="form-check mb-3">
      <input class="form-check-input component-config" type="checkbox" data-config-key="enforce_schema" id="enforce-schema" checked>
      <label class="form-check-label" for="enforce-schema">
        Strictly enforce schema
      </label>
    </div>
  </div>
</div>

<!-- Modal for connection configuration -->
<div class="modal fade" id="connection-modal" tabindex="-1" aria-labelledby="connectionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="connectionModalLabel">Configure Connection</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="connection-form">
          <div class="mb-3">
            <label for="connection-type" class="form-label">Connection Type</label>
            <select class="form-select" id="connection-type">
              <option value="data">Data Flow</option>
              <option value="control">Control Flow</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="connection-description" class="form-label">Description</label>
            <input type="text" class="form-control" id="connection-description" placeholder="Optional description">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-connection">Save Connection</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsPlumb/2.15.6/js/jsplumb.min.js"></script>
<script src="{{ url_for('static', filename='js/agent_builder.js') }}"></script>
{% endblock %}