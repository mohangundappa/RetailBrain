{% extends "base.html" %}

{% block title %}Staples Brain - AI Super Brain{% endblock %}

{% block header %}
<header class="brain-header text-white text-center">
    <div class="container">
        <h1 class="display-4"><i class="fas fa-brain"></i> Staples Brain</h1>
        <p class="lead">A modular AI super brain system with specialized agents</p>
    </div>
</header>
{% endblock %}

{% block content %}
<!-- Tabs Navigation -->
<ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="system-status-tab" data-bs-toggle="tab" data-bs-target="#system-status" type="button" role="tab" aria-controls="system-status" aria-selected="true">
            <i class="fas fa-server"></i> System Status
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat-with-brain" type="button" role="tab" aria-controls="chat-with-brain" aria-selected="false">
            <i class="fas fa-comments"></i> Chat With Staples Brain
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="agents-tab" data-bs-toggle="tab" data-bs-target="#available-agents" type="button" role="tab" aria-controls="available-agents" aria-selected="false">
            <i class="fas fa-robot"></i> Available Agents
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="mainTabsContent">
    <!-- System Status Tab -->
    <div class="tab-pane fade show active" id="system-status" role="tabpanel" aria-labelledby="system-status-tab">
        <div class="row mb-4">
            <div class="col-md-10 offset-md-1">
                <div class="card bg-dark text-light">
                    <div class="card-body">
                        <h3 class="card-title mb-4">System Status</h3>
                        <div class="row text-center">
                            <div class="col-md-4 mb-4">
                                <div class="status-indicator p-3 border rounded">
                                    <div class="status-icon mb-3">
                                        <i class="fas fa-database fa-3x {% if stats.database_connected %}text-success{% else %}text-danger{% endif %}"></i>
                                    </div>
                                    <h4 class="status-text">Database</h4>
                                    <div class="status-value">
                                        <span class="badge {% if stats.database_connected %}bg-success{% else %}bg-danger{% endif %} p-2">
                                            {% if stats.database_connected %}Connected{% else %}Disconnected{% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-4">
                                <div class="status-indicator p-3 border rounded">
                                    <div class="status-icon mb-3">
                                        <i class="fas fa-robot fa-3x {% if stats.llm_integration %}text-success{% else %}text-warning{% endif %}"></i>
                                    </div>
                                    <h4 class="status-text">LLM Integration</h4>
                                    <div class="status-value">
                                        <span class="badge {% if stats.llm_integration %}bg-success{% else %}bg-warning text-dark{% endif %} p-2">
                                            {% if stats.llm_integration %}Active{% else %}Inactive{% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-4">
                                <div class="status-indicator p-3 border rounded">
                                    <div class="status-icon mb-3">
                                        <i class="fas fa-tachometer-alt fa-3x text-info"></i>
                                    </div>
                                    <h4 class="status-text">Observability</h4>
                                    <div class="status-value">
                                        <a href="/dashboard" class="btn btn-outline-info">View Dashboard</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row text-center mt-3">
                            <div class="col-md-6 mb-4">
                                <div class="status-indicator p-3 border rounded">
                                    <div class="status-icon mb-3">
                                        <i class="fas fa-comments fa-3x text-primary"></i>
                                    </div>
                                    <h4 class="status-text">Conversations</h4>
                                    <div class="status-value">
                                        <h3>{{ stats.conversation_count }}</h3>
                                        <p class="text-muted">Total conversations</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="status-indicator p-3 border rounded">
                                    <div class="status-icon mb-3">
                                        <i class="fas fa-cogs fa-3x text-primary"></i>
                                    </div>
                                    <h4 class="status-text">Agents</h4>
                                    <div class="status-value">
                                        <h3>{{ stats.available_agents|length }}</h3>
                                        <p class="text-muted">Active agents</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Conversation History Section -->
        <div class="mt-4">
            <div class="card bg-dark text-light">
                <div class="card-header">
                    <h4 class="mb-0">Recent Conversations</h4>
                </div>
                <div class="card-body">
                    <div id="conversations-list">
                        {% if stats.total_conversations and stats.total_conversations > 0 %}
                            <div class="table-responsive">
                                <table class="table table-dark table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>User Input</th>
                                            <th>Intent</th>
                                            <th>Agent</th>
                                            <th>Created</th>
                                        </tr>
                                    </thead>
                                    <tbody id="conversations-table-body">
                                        <!-- Will be populated via API -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="text-center mt-3">
                                <button id="load-conversations" class="btn btn-outline-info">Load Recent Conversations</button>
                            </div>
                        {% else %}
                            <div class="text-center text-muted">
                                <p>No conversations yet. Try asking Staples Brain a question!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chat Tab -->
    <div class="tab-pane fade" id="chat-with-brain" role="tabpanel" aria-labelledby="chat-tab">
        <div class="row">
            <div class="col-lg-10 offset-lg-1">
                <div class="card bg-dark text-light">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h3 class="card-title mb-0">Chat with Staples Brain</h3>
                            <button id="new-session-btn" class="btn btn-outline-warning">
                                <i class="fas fa-plus"></i> New Session
                            </button>
                        </div>
                        
                        <!-- Chat History -->
                        <div class="chat-container mb-3" id="chat-container">
                            <div class="welcome-message">
                                <div class="message-wrapper">
                                    <div class="avatar brain-avatar">
                                        <i class="fas fa-brain"></i>
                                    </div>
                                    <div class="message brain-message">
                                        <p>Hello! I'm Staples Brain, here to assist you with various Staples services. How can I help you today?</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <form id="brain-form">
                            <div class="mb-3">
                                <textarea id="user-input" class="form-control" rows="3" placeholder="Ask about package tracking, password reset, or anything else..."></textarea>
                            </div>
                            <div class="d-flex">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-paper-plane"></i> Send
                                </button>
                                <button type="button" id="clear-chat-btn" class="btn btn-outline-secondary">
                                    <i class="fas fa-eraser"></i> Clear Chat
                                </button>
                            </div>
                        </form>
                        <div class="loading-indicator" id="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Thinking...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Available Agents Tab -->
    <div class="tab-pane fade" id="available-agents" role="tabpanel" aria-labelledby="agents-tab">
        <div class="text-center mb-4">
            <h2 class="d-inline-block me-3">Available Agents</h2>
            <a href="{{ url_for('agent_diagrams') }}" class="btn btn-success">
                <i class="fas fa-plus-circle"></i> Create New Agent
            </a>
        </div>

        <div class="row mb-4">
            <div class="col-md-6 mb-4">
                <div class="card agent-card bg-dark text-light h-100">
                    <div class="card-body text-center">
                        <div class="agent-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <h3 class="card-title">Package Tracking</h3>
                        <p class="card-text">Track your packages and check delivery status</p>
                        <button class="btn btn-outline-info" onclick="setPrompt('Track my package with tracking number TRACK123456')">Try Package Tracking</button>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card agent-card bg-dark text-light h-100">
                    <div class="card-body text-center">
                        <div class="agent-icon">
                            <i class="fas fa-key"></i>
                        </div>
                        <h3 class="card-title">Password Reset</h3>
                        <p class="card-text">Reset your password and recover your account</p>
                        <button class="btn btn-outline-info" onclick="setPrompt('I need to reset my password for user@example.com')">Try Password Reset</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6 mb-4">
                <div class="card agent-card bg-dark text-light h-100">
                    <div class="card-body text-center">
                        <div class="agent-icon">
                            <i class="fas fa-store"></i>
                        </div>
                        <h3 class="card-title">Store Locator</h3>
                        <p class="card-text">Find Staples stores near you</p>
                        <button class="btn btn-outline-info" onclick="setPrompt('Find Staples stores near 10001')">Try Store Locator</button>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card agent-card bg-dark text-light h-100">
                    <div class="card-body text-center">
                        <div class="agent-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <h3 class="card-title">Product Information</h3>
                        <p class="card-text">Get information about Staples products</p>
                        <button class="btn btn-outline-info" onclick="setPrompt('Tell me about Staples Hyken Mesh Task Chair')">Try Product Info</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 offset-md-3 mb-4">
                <div class="card agent-card bg-dark text-light h-100">
                    <div class="card-body text-center">
                        <div class="agent-icon">
                            <i class="fas fa-undo"></i>
                        </div>
                        <h3 class="card-title">Returns Processing</h3>
                        <p class="card-text">Process returns for Staples orders and purchases</p>
                        <button class="btn btn-outline-info" onclick="setPrompt('I need to return an order I placed last week')">Try Returns Processing</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Function to set prompt text in the input field and switch to chat tab
    function setPrompt(text) {
        document.getElementById('user-input').value = text;
        // Switch to chat tab
        document.getElementById('chat-tab').click();
        // Focus on the input
        document.getElementById('user-input').focus();
    }

    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('brain-form');
        const userInput = document.getElementById('user-input');
        const chatContainer = document.getElementById('chat-container');
        const loading = document.getElementById('loading');
        const newSessionBtn = document.getElementById('new-session-btn');
        const clearChatBtn = document.getElementById('clear-chat-btn');
        const loadConversationsBtn = document.getElementById('load-conversations');
        
        let sessionId = Date.now().toString();
        loading.style.display = 'none';
        
        // Handle form submission
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const message = userInput.value.trim();
                
                if (message) {
                    // Add user message to chat
                    const userMessageHtml = `
                        <div class="message-wrapper user-message-wrapper">
                            <div class="message user-message">
                                <p>${message}</p>
                            </div>
                            <div class="avatar user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                        </div>
                    `;
                    chatContainer.innerHTML += userMessageHtml;
                    
                    // Clear input
                    userInput.value = '';
                    
                    // Show loading
                    loading.style.display = 'flex';
                    
                    // Scroll to bottom
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    
                    // Send to server
                    fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            session_id: sessionId
                        }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Hide loading
                        loading.style.display = 'none';
                        
                        // Add brain message to chat
                        const brainMessageHtml = `
                            <div class="message-wrapper">
                                <div class="avatar brain-avatar">
                                    <i class="fas fa-brain"></i>
                                </div>
                                <div class="message brain-message">
                                    <p>${data.response}</p>
                                    ${data.agent ? `<div class="badge bg-info mt-2">Agent: ${data.agent}</div>` : ''}
                                </div>
                            </div>
                        `;
                        chatContainer.innerHTML += brainMessageHtml;
                        
                        // Scroll to bottom
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        loading.style.display = 'none';
                        
                        // Add error message
                        const errorMessageHtml = `
                            <div class="message-wrapper">
                                <div class="avatar brain-avatar">
                                    <i class="fas fa-brain"></i>
                                </div>
                                <div class="message brain-message error-message">
                                    <p>Sorry, I encountered an error. Please try again later.</p>
                                </div>
                            </div>
                        `;
                        chatContainer.innerHTML += errorMessageHtml;
                        
                        // Scroll to bottom
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    });
                }
            });
        }
        
        // Handle new session
        if (newSessionBtn) {
            newSessionBtn.addEventListener('click', function() {
                sessionId = Date.now().toString();
                chatContainer.innerHTML = `
                    <div class="welcome-message">
                        <div class="message-wrapper">
                            <div class="avatar brain-avatar">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div class="message brain-message">
                                <p>Hello! I'm Staples Brain, here to assist you with various Staples services. How can I help you today?</p>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        // Handle clear chat
        if (clearChatBtn) {
            clearChatBtn.addEventListener('click', function() {
                chatContainer.innerHTML = `
                    <div class="welcome-message">
                        <div class="message-wrapper">
                            <div class="avatar brain-avatar">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div class="message brain-message">
                                <p>Hello! I'm Staples Brain, here to assist you with various Staples services. How can I help you today?</p>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        // Load conversations
        if (loadConversationsBtn) {
            loadConversationsBtn.addEventListener('click', function() {
                fetch('/api/conversations')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('conversations-table-body');
                    tableBody.innerHTML = '';
                    
                    if (data && data.conversations && data.conversations.length) {
                        data.conversations.slice(0, 10).forEach(conv => {
                            const row = document.createElement('tr');
                            
                            const idCell = document.createElement('td');
                            idCell.textContent = conv.id;
                            
                            const inputCell = document.createElement('td');
                            inputCell.textContent = conv.user_input.length > 50 ? 
                                conv.user_input.substring(0, 50) + '...' : 
                                conv.user_input;
                            
                            const intentCell = document.createElement('td');
                            intentCell.textContent = conv.intent || 'Unknown';
                            
                            const agentCell = document.createElement('td');
                            agentCell.textContent = conv.selected_agent || 'None';
                            
                            const createdCell = document.createElement('td');
                            const date = new Date(conv.created_at);
                            createdCell.textContent = date.toLocaleString();
                            
                            row.appendChild(idCell);
                            row.appendChild(inputCell);
                            row.appendChild(intentCell);
                            row.appendChild(agentCell);
                            row.appendChild(createdCell);
                            
                            tableBody.appendChild(row);
                        });
                    } else {
                        const row = document.createElement('tr');
                        const cell = document.createElement('td');
                        cell.setAttribute('colspan', '5');
                        cell.classList.add('text-center');
                        cell.textContent = 'No conversations found';
                        row.appendChild(cell);
                        tableBody.appendChild(row);
                    }
                })
                .catch(error => {
                    console.error('Error loading conversations:', error);
                });
            });
        }
    });
</script>
{% endblock %}