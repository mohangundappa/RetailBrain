{% extends "base.html" %}

{% block title %}Staples Brain - Agent Template Gallery{% endblock %}

{% block header %}
<header class="brain-header text-white text-center">
    <div class="container">
        <h1 class="display-4"><i class="fas fa-puzzle-piece"></i> Agent Template Gallery</h1>
        <p class="lead">Jumpstart your agent creation with these pre-built templates</p>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card bg-dark text-light">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="fas fa-filter"></i> Filter Templates</h5>
                        <button class="btn btn-sm btn-outline-secondary" id="reset-filters">Reset</button>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group mb-2">
                                <label for="category-filter">Category</label>
                                <select id="category-filter" class="form-control bg-dark text-light">
                                    <option value="">All Categories</option>
                                    <option value="customer-service">Customer Service</option>
                                    <option value="sales">Sales</option>
                                    <option value="support">Technical Support</option>
                                    <option value="ecommerce">E-Commerce</option>
                                    <option value="internal">Internal Tools</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-2">
                                <label for="tag-filter">Tags</label>
                                <input type="text" id="tag-filter" class="form-control bg-dark text-light" placeholder="e.g., order, tracking, retail">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-2">
                                <label for="sort-filter">Sort By</label>
                                <select id="sort-filter" class="form-control bg-dark text-light">
                                    <option value="featured">Featured</option>
                                    <option value="downloads">Most Downloaded</option>
                                    <option value="rating">Highest Rated</option>
                                    <option value="newest">Newest</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Featured Templates -->
    <div class="mb-5">
        <h2 class="mb-4"><i class="fas fa-star text-warning"></i> Featured Templates</h2>
        <div class="row" id="featured-templates">
            {% for template in featured_templates %}
            <div class="col-md-4 mb-4 template-card" 
                 data-category="{{ template.category }}" 
                 data-tags="{{ template.tags }}" 
                 data-featured="{{ template.is_featured|lower }}"
                 data-downloads="{{ template.downloads }}"
                 data-rating="{{ template.rating }}">
                <div class="card h-100 bg-dark text-light template-card-inner">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="{{ template.icon or 'fas fa-robot' }}"></i> {{ template.name }}</span>
                        <span class="badge bg-warning">Featured</span>
                    </div>
                    {% if template.screenshot %}
                    <img src="{{ template.screenshot }}" class="card-img-top template-thumbnail" alt="{{ template.name }}">
                    {% else %}
                    <div class="template-placeholder d-flex align-items-center justify-content-center">
                        <i class="fas fa-image fa-3x text-secondary"></i>
                    </div>
                    {% endif %}
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">{{ template.name }}</h5>
                        <p class="card-text">{{ template.description }}</p>
                        <div class="template-metrics mt-auto">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-info"><i class="fas fa-download"></i> {{ template.downloads }}</span>
                                <div class="rating">
                                    {% for i in range(5) %}
                                        {% if i < template.rating|int %}
                                        <i class="fas fa-star text-warning"></i>
                                        {% elif i == template.rating|int and template.rating % 1 > 0 %}
                                        <i class="fas fa-star-half-alt text-warning"></i>
                                        {% else %}
                                        <i class="far fa-star text-warning"></i>
                                        {% endif %}
                                    {% endfor %}
                                    <span class="text-muted">({{ template.rating_count }})</span>
                                </div>
                            </div>
                            <div class="template-tags">
                                {% for tag in template.get_tags_list() %}
                                <span class="badge bg-secondary me-1">{{ tag }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-outline-info btn-sm template-preview" data-id="{{ template.id }}">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                            <a href="{{ url_for('agent_wizard', template_id=template.id) }}" class="btn btn-primary btn-sm">
                                <i class="fas fa-plus"></i> Use Template
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="col-12">
                <div class="alert alert-info">
                    No featured templates available at this time.
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- All Templates -->
    <div>
        <h2 class="mb-4"><i class="fas fa-th-large"></i> All Templates</h2>
        <div class="row" id="all-templates">
            {% for template in templates %}
            <div class="col-md-4 mb-4 template-card" 
                 data-category="{{ template.category }}" 
                 data-tags="{{ template.tags }}" 
                 data-featured="{{ template.is_featured|lower }}"
                 data-downloads="{{ template.downloads }}"
                 data-rating="{{ template.rating }}">
                <div class="card h-100 bg-dark text-light template-card-inner">
                    <div class="card-header">
                        <i class="{{ template.icon or 'fas fa-robot' }}"></i> {{ template.name }}
                    </div>
                    {% if template.screenshot %}
                    <img src="{{ template.screenshot }}" class="card-img-top template-thumbnail" alt="{{ template.name }}">
                    {% else %}
                    <div class="template-placeholder d-flex align-items-center justify-content-center">
                        <i class="fas fa-image fa-3x text-secondary"></i>
                    </div>
                    {% endif %}
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">{{ template.name }}</h5>
                        <p class="card-text">{{ template.description }}</p>
                        <div class="template-metrics mt-auto">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-info"><i class="fas fa-download"></i> {{ template.downloads }}</span>
                                <div class="rating">
                                    {% for i in range(5) %}
                                        {% if i < template.rating|int %}
                                        <i class="fas fa-star text-warning"></i>
                                        {% elif i == template.rating|int and template.rating % 1 > 0 %}
                                        <i class="fas fa-star-half-alt text-warning"></i>
                                        {% else %}
                                        <i class="far fa-star text-warning"></i>
                                        {% endif %}
                                    {% endfor %}
                                    <span class="text-muted">({{ template.rating_count }})</span>
                                </div>
                            </div>
                            <div class="template-tags">
                                {% for tag in template.get_tags_list() %}
                                <span class="badge bg-secondary me-1">{{ tag }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-outline-info btn-sm template-preview" data-id="{{ template.id }}">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                            <a href="{{ url_for('agent_wizard', template_id=template.id) }}" class="btn btn-primary btn-sm">
                                <i class="fas fa-plus"></i> Use Template
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="col-12">
                <div class="alert alert-info">
                    No templates available at this time.
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Create Your Own Template Button -->
    <div class="mt-5 text-center">
        <p class="lead">Don't see what you're looking for?</p>
        <a href="{{ url_for('agent_wizard') }}" class="btn btn-success btn-lg">
            <i class="fas fa-plus-circle"></i> Create Your Own Agent
        </a>
    </div>
</div>

<!-- Template Preview Modal -->
<div class="modal fade" id="template-preview-modal" tabindex="-1" aria-labelledby="template-preview-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="template-preview-modal-label">Template Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="template-preview-content">
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="use-template-btn" class="btn btn-primary">Use This Template</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter functionality
    const categoryFilter = document.getElementById('category-filter');
    const tagFilter = document.getElementById('tag-filter');
    const sortFilter = document.getElementById('sort-filter');
    const resetFiltersBtn = document.getElementById('reset-filters');
    
    const applyFilters = () => {
        const category = categoryFilter.value;
        const tags = tagFilter.value.toLowerCase().split(',').map(tag => tag.trim());
        const sortBy = sortFilter.value;
        
        // Get all template cards
        const templates = document.querySelectorAll('.template-card');
        
        templates.forEach(card => {
            // Check category filter
            const cardCategory = card.dataset.category;
            const categoryMatch = !category || cardCategory === category;
            
            // Check tag filter
            const cardTags = card.dataset.tags.toLowerCase();
            const tagMatch = !tags[0] || tags.some(tag => cardTags.includes(tag));
            
            // Show or hide based on filters
            if (categoryMatch && tagMatch) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
        
        // Sort templates
        const featuredContainer = document.getElementById('featured-templates');
        const allTemplatesContainer = document.getElementById('all-templates');
        
        const sortTemplates = (container) => {
            if (!container) return;
            
            const cards = Array.from(container.querySelectorAll('.template-card'));
            cards.sort((a, b) => {
                if (sortBy === 'featured') {
                    return b.dataset.featured === 'true' ? 1 : -1;
                } else if (sortBy === 'downloads') {
                    return parseInt(b.dataset.downloads) - parseInt(a.dataset.downloads);
                } else if (sortBy === 'rating') {
                    return parseFloat(b.dataset.rating) - parseFloat(a.dataset.rating);
                } else if (sortBy === 'newest') {
                    // We don't have a date in the data attributes yet, so this is just a placeholder
                    return 0;
                }
                return 0;
            });
            
            // Reappend in sorted order
            cards.forEach(card => container.appendChild(card));
        };
        
        sortTemplates(featuredContainer);
        sortTemplates(allTemplatesContainer);
    };
    
    // Add event listeners for filters
    categoryFilter.addEventListener('change', applyFilters);
    tagFilter.addEventListener('input', debounce(applyFilters, 300));
    sortFilter.addEventListener('change', applyFilters);
    
    // Reset filters
    resetFiltersBtn.addEventListener('click', () => {
        categoryFilter.value = '';
        tagFilter.value = '';
        sortFilter.value = 'featured';
        applyFilters();
    });
    
    // Template preview modal
    const previewBtns = document.querySelectorAll('.template-preview');
    const previewModal = new bootstrap.Modal(document.getElementById('template-preview-modal'));
    const previewContent = document.getElementById('template-preview-content');
    const useTemplateBtn = document.getElementById('use-template-btn');
    
    previewBtns.forEach(btn => {
        btn.addEventListener('click', async function() {
            const templateId = this.dataset.id;
            useTemplateBtn.href = `/agent-wizard?template_id=${templateId}`;
            
            // Show loading
            previewContent.innerHTML = `
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            
            previewModal.show();
            
            try {
                const response = await fetch(`/api/templates/${templateId}`);
                const data = await response.json();
                
                if (data.success) {
                    const template = data.template;
                    
                    // Format the preview content
                    let html = `
                        <div class="row">
                            <div class="col-md-6">
                                ${template.screenshot ? 
                                  `<img src="${template.screenshot}" class="img-fluid mb-3 rounded" alt="${template.name}">` : 
                                  `<div class="template-placeholder-lg d-flex align-items-center justify-content-center rounded">
                                     <i class="fas fa-image fa-5x text-secondary"></i>
                                   </div>`
                                }
                                <h4>${template.name}</h4>
                                <p>${template.description}</p>
                                <div class="mb-3">
                                    <strong>Category:</strong> ${template.category || 'Uncategorized'}
                                </div>
                                <div class="mb-3">
                                    <strong>Created By:</strong> ${template.author || 'System'}
                                </div>
                                <div class="template-metrics mb-3">
                                    <div class="rating">
                                        <strong>Rating:</strong> 
                                        ${generateStars(template.rating)}
                                        <span class="text-muted">(${template.rating_count} ratings)</span>
                                    </div>
                                    <div>
                                        <strong>Downloads:</strong> ${template.downloads}
                                    </div>
                                </div>
                                <div class="template-tags">
                                    <strong>Tags:</strong><br>
                                    ${template.tags ? template.tags.split(',').map(tag => 
                                      `<span class="badge bg-secondary me-1">${tag.trim()}</span>`
                                    ).join('') : 'No tags'}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5>Entities Included:</h5>
                                <div class="entity-list mb-3">
                                    ${template.entity_definitions ? formatEntityDefinitions(template.entity_definitions) : 'No entity definitions'}
                                </div>
                                
                                <h5>Sample Prompts:</h5>
                                <div class="prompt-preview mb-3">
                                    ${template.prompt_templates ? formatPromptTemplates(template.prompt_templates) : 'No prompt templates'}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    previewContent.innerHTML = html;
                } else {
                    previewContent.innerHTML = `<div class="alert alert-danger">Error loading template: ${data.error}</div>`;
                }
                
            } catch (error) {
                previewContent.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        });
    });
    
    // Helper functions
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }
    
    function generateStars(rating) {
        let stars = '';
        for (let i = 0; i < 5; i++) {
            if (i < Math.floor(rating)) {
                stars += '<i class="fas fa-star text-warning"></i>';
            } else if (i === Math.floor(rating) && rating % 1 > 0) {
                stars += '<i class="fas fa-star-half-alt text-warning"></i>';
            } else {
                stars += '<i class="far fa-star text-warning"></i>';
            }
        }
        return stars;
    }
    
    function formatEntityDefinitions(entityDefinitionsJson) {
        try {
            const entities = JSON.parse(entityDefinitionsJson);
            if (!entities.length) return 'No entities defined';
            
            let html = '<div class="list-group">';
            entities.forEach(entity => {
                html += `
                    <div class="list-group-item bg-dark text-light border-secondary">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>${entity.name}</strong>
                            ${entity.required ? '<span class="badge bg-danger">Required</span>' : '<span class="badge bg-secondary">Optional</span>'}
                        </div>
                        <div class="small text-muted">${entity.description || 'No description'}</div>
                        ${entity.validation_pattern ? `<div class="small"><span class="badge bg-info">Validation:</span> ${entity.validation_pattern}</div>` : ''}
                    </div>
                `;
            });
            html += '</div>';
            return html;
        } catch (e) {
            return 'Unable to parse entity definitions';
        }
    }
    
    function formatPromptTemplates(promptTemplatesJson) {
        try {
            const templates = JSON.parse(promptTemplatesJson);
            if (Object.keys(templates).length === 0) return 'No prompt templates defined';
            
            let html = '<div class="accordion" id="promptAccordion">';
            let counter = 0;
            
            for (const [key, value] of Object.entries(templates)) {
                counter++;
                html += `
                    <div class="accordion-item bg-dark border-secondary">
                        <h2 class="accordion-header" id="heading${counter}">
                            <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${counter}" aria-expanded="false" aria-controls="collapse${counter}">
                                ${key}
                            </button>
                        </h2>
                        <div id="collapse${counter}" class="accordion-collapse collapse" aria-labelledby="heading${counter}" data-bs-parent="#promptAccordion">
                            <div class="accordion-body">
                                <pre class="prompt-code">${value}</pre>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        } catch (e) {
            return 'Unable to parse prompt templates';
        }
    }
});
</script>
{% endblock %}