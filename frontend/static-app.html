<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staples Brain - Customer Engagement AI</title>
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Main layout containers */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Fixed side panel */
        .side-panel {
            width: 250px;
            background-color: rgba(0, 0, 0, 0.2);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            padding: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        /* Main content area */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px 30px;
            transition: all 0.3s ease;
        }
        
        /* Sidebar branding */
        .sidebar-branding {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1rem;
        }
        
        .sidebar-branding h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        /* Nav menu */
        .sidebar-nav .nav-item {
            margin-bottom: 0.25rem;
            padding: 0 0.75rem;
        }
        
        .sidebar-nav .nav-link {
            color: rgba(255, 255, 255, 0.7);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .sidebar-nav .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .sidebar-nav .nav-link.active {
            color: white;
            background-color: var(--bs-primary);
        }
        
        .sidebar-nav .nav-link .bi {
            margin-right: 0.75rem;
        }
        
        /* Cards */
        .card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-bottom: 1.5rem;
            height: 100%;
            border-radius: 0.5rem;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .card-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--bs-info);
        }
        
        .agent-card {
            border-left: 4px solid var(--bs-primary);
        }
        
        /* Stats */
        .stats-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 1rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--bs-secondary);
        }
        
        /* Footer */
        .footer {
            margin-top: 3rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        
        /* Alerts */
        .connection-issue {
            background-color: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.2);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        /* Badges */
        .agent-type-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 0.7rem;
        }
        
        /* Chat split screen layout */
        .chat-split-container {
            display: flex;
            height: calc(100vh - 180px);
            gap: 1rem;
        }
        
        .chat-panel {
            flex: 1;
            min-width: 0; /* Prevent flex items from overflowing */
            transition: all 0.3s ease;
        }
        
        .observability-panel {
            flex: 1;
            min-width: 0; /* Prevent flex items from overflowing */
            transition: all 0.3s ease;
        }
        
        .chat-container, .observability-container {
            height: 100%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages, .observability-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Chat messages */
        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
            transition: all 0.2s ease;
        }
        
        .message:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .message.selected {
            border: 1px solid var(--bs-primary);
        }
        
        .message-user {
            background-color: rgba(13, 110, 253, 0.1);
            align-self: flex-end;
        }
        
        .message-assistant {
            background-color: rgba(32, 32, 32, 0.3);
            align-self: flex-start;
        }
        
        .message-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 0.5rem;
        }
        
        .message-content {
            padding: 0.25rem 0;
        }
        
        /* Observability Components */
        .observability-section {
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .section-title {
            margin-bottom: 1rem;
            color: var(--bs-info);
            font-weight: 500;
        }
        
        .agent-selection-flow {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .agent-node {
            display: flex;
            align-items: center;
            background-color: rgba(32, 32, 32, 0.5);
            border-radius: 0.5rem;
            padding: 0.5rem;
            opacity: 0.5;
            transition: all 0.2s ease;
        }
        
        .agent-node.selected {
            opacity: 1;
            border: 1px solid var(--bs-success);
        }
        
        .agent-icon {
            background-color: rgba(13, 110, 253, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
        }
        
        .flow-arrow {
            font-size: 1.5rem;
            color: var(--bs-secondary);
        }
        
        .tool-execution {
            background-color: rgba(32, 32, 32, 0.3);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .tool-name {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .tool-details {
            padding-left: 0.5rem;
            border-left: 2px solid var(--bs-secondary);
        }
        
        .entity-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .observability-message {
            display: none;
        }
        
        .observability-message.active {
            display: block;
        }
        
        .observability-placeholder {
            display: block;
        }
        
        .observability-placeholder.hidden {
            display: none;
        }
        
        /* Status indicators */
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .status-connected {
            background-color: var(--bs-success);
        }
        
        .status-disconnected {
            background-color: var(--bs-danger);
        }
        
        .status-sending {
            background-color: var(--bs-warning);
        }
        
        /* Agent Builder */
        .agent-builder-container {
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            padding: 1.5rem;
        }
        
        .agent-builder-placeholder {
            text-align: center;
            padding: 3rem;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 992px) {
            .side-panel {
                width: 200px;
            }
            .main-content {
                margin-left: 200px;
                padding: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .side-panel {
                left: -250px;
            }
            .side-panel.show {
                left: 0;
            }
            .main-content {
                margin-left: 0;
                padding: 15px;
            }
            .menu-toggle {
                display: block;
                position: fixed;
                top: 15px;
                left: 15px;
                z-index: 1100;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Fixed Side Panel -->
        <aside class="side-panel">
            <div class="sidebar-branding">
                <h3>Staples Brain</h3>
                <p class="text-muted small mb-0">AI Engagement Platform</p>
            </div>
            
            <ul class="sidebar-nav nav flex-column" id="mainTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="home-tab" data-bs-toggle="tab" href="#home-tab-pane" role="tab" aria-controls="home-tab-pane" aria-selected="true">
                        <i class="bi bi-house-door"></i>
                        Home
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="chat-tab" data-bs-toggle="tab" href="#chat-tab-pane" role="tab" aria-controls="chat-tab-pane" aria-selected="false">
                        <i class="bi bi-chat-dots"></i>
                        Chat
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="builder-tab" data-bs-toggle="tab" href="#builder-tab-pane" role="tab" aria-controls="builder-tab-pane" aria-selected="false">
                        <i class="bi bi-gear"></i>
                        Agent Builder
                    </a>
                </li>
                <li class="nav-item mt-3">
                    <hr class="dropdown-divider bg-secondary">
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="agents-tab" data-bs-toggle="tab" href="#agents-tab-pane" role="tab" aria-controls="agents-tab-pane" aria-selected="false">
                        <i class="bi bi-robot"></i>
                        Agent List
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">
                        <i class="bi bi-graph-up"></i>
                        Analytics
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">
                        <i class="bi bi-sliders"></i>
                        Settings
                    </a>
                </li>
            </ul>
            
            <div class="position-absolute bottom-0 start-0 w-100 p-3 border-top border-secondary">
                <div class="d-flex align-items-center">
                    <span class="badge bg-success me-2">
                        <span class="status-indicator status-connected"></span>
                        System Online
                    </span>
                    <small class="text-muted">v1.0.0</small>
                </div>
            </div>
        </aside>
        
        <!-- Main Content Area -->
        <main class="main-content">
            <div class="tab-content" id="mainTabsContent">
            <div class="tab-pane fade show active" id="home-tab-pane" role="tabpanel" aria-labelledby="home-tab" tabindex="0">
                <div class="stats-container">
                    <div class="row">
                        <div class="col-md-3 col-6">
                            <div class="stat-item">
                                <div class="stat-value text-primary" id="agent-count">7</div>
                                <div class="stat-label">Active Agents</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="stat-item">
                                <div class="stat-value text-success">98.5%</div>
                                <div class="stat-label">System Uptime</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="stat-item">
                                <div class="stat-value text-info">2.1s</div>
                                <div class="stat-label">Avg. Response Time</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="stat-item">
                                <div class="stat-value text-warning">94%</div>
                                <div class="stat-label">Success Rate</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h3 class="mb-4">Features & Interfaces</h3>
                
                <div class="row">
                    <div class="col-lg-6 col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="card-icon">
                                    <i class="bi bi-chat-dots"></i>
                                </div>
                                <h5 class="card-title">Chat Interface</h5>
                                <p class="card-text">Chat interface for interacting with Staples Brain and its specialized agents.</p>
                                <button class="btn btn-outline-primary mt-3" id="launch-chat-btn">
                                    <i class="bi bi-arrow-right-circle me-2"></i>
                                    Launch Chat
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6 col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="card-icon">
                                    <i class="bi bi-diagram-3"></i>
                                </div>
                                <h5 class="card-title">Routing Architecture</h5>
                                <p class="card-text">View the agent routing architecture diagram.</p>
                                <a href="/routing-architecture" class="btn btn-outline-secondary mt-3">
                                    <i class="bi bi-arrow-right-circle me-2"></i>
                                    View Diagram
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h3 class="mb-4 mt-5">Active Specialized Agents</h3>
                <div id="agent-connection-alert" class="connection-issue" style="display: none;">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
                        <span>Unable to fetch live agent data. Showing cached data instead.</span>
                    </div>
                </div>
                
                <div class="row" id="agent-cards-container">
                    <!-- Agent cards will be loaded here -->
                </div>
            </div>
            
            <div class="tab-pane fade" id="chat-tab-pane" role="tabpanel" aria-labelledby="chat-tab" tabindex="0">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h3 class="mb-0">Interactive Chat</h3>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-success me-2" id="chat-connection-status">
                            <span class="status-indicator status-connected"></span>
                            Connected
                        </span>
                        <button class="btn btn-sm btn-outline-secondary observability-toggle" id="toggle-observability">
                            <i class="bi bi-layout-split"></i>
                            <span>Toggle Observability</span>
                        </button>
                    </div>
                </div>
                
                <div class="chat-split-container">
                    <!-- Chat Panel -->
                    <div class="chat-panel" id="chat-panel">
                        <div class="chat-container">
                            <div class="chat-header d-flex justify-content-between align-items-center p-3 border-bottom">
                                <div>
                                    <h5 class="mb-0">Staples Brain Chat</h5>
                                    <div class="text-muted small">AI Customer Assistant</div>
                                </div>
                            </div>
                            
                            <div class="chat-messages p-3" id="embedded-chat-messages">
                                <!-- Messages will be displayed here -->
                                <div class="message message-assistant" data-message-id="welcome-msg-001">
                                    <div class="message-header d-flex justify-content-between align-items-start mb-2">
                                        <div class="agent-badge">
                                            <span class="badge bg-info">System</span>
                                        </div>
                                        <button class="btn btn-sm btn-link text-muted observability-msg-toggle" data-message-id="welcome-msg-001">
                                            <i class="bi bi-eye-fill"></i> View Details
                                        </button>
                                    </div>
                                    <div class="message-content">Hello! I'm the Staples Brain assistant. How can I help you today?</div>
                                    <div class="text-muted small mt-1">12:00:00 PM</div>
                                </div>
                            </div>
                            
                            <div class="chat-input-container p-3 border-top">
                                <form id="embedded-chat-form" class="d-flex">
                                    <input type="text" id="embedded-chat-input" class="form-control me-2" placeholder="Type your message..." autocomplete="off">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-send"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Observability Panel -->
                    <div class="observability-panel" id="observability-panel">
                        <div class="observability-container">
                            <div class="observability-header d-flex justify-content-between align-items-center p-3 border-bottom">
                                <div>
                                    <h5 class="mb-0">Observability</h5>
                                    <div class="text-muted small">Agent Selection & Processing</div>
                                </div>
                                <div>
                                    <span class="badge bg-info" id="observability-connection-status">
                                        <span class="status-indicator status-connected"></span>
                                        API Connected
                                    </span>
                                </div>
                            </div>
                            
                            <div class="observability-content p-3" id="observability-content">
                                <div class="observability-message" id="obs-welcome-msg-001">
                                    <div class="observability-section mb-4">
                                        <h6 class="section-title">
                                            <i class="bi bi-robot me-2"></i>
                                            Agent Selection
                                        </h6>
                                        <div class="section-content">
                                            <div class="agent-selection-flow">
                                                <div class="agent-node selected">
                                                    <div class="agent-icon">
                                                        <i class="bi bi-shield-check"></i>
                                                    </div>
                                                    <div class="agent-info">
                                                        <div class="agent-name">Guardrails Agent</div>
                                                        <div class="agent-description small">Safety validation passed</div>
                                                    </div>
                                                </div>
                                                <div class="flow-arrow">→</div>
                                                <div class="agent-node selected">
                                                    <div class="agent-icon">
                                                        <i class="bi bi-chat-dots"></i>
                                                    </div>
                                                    <div class="agent-info">
                                                        <div class="agent-name">General Conversation Agent</div>
                                                        <div class="agent-description small">Greeting pattern matched</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="observability-section mb-4">
                                        <h6 class="section-title">
                                            <i class="bi bi-tools me-2"></i>
                                            Tools Executed
                                        </h6>
                                        <div class="section-content">
                                            <div class="tool-execution">
                                                <div class="tool-name">SystemGreetingTool</div>
                                                <div class="tool-details small">
                                                    <div class="tool-params">
                                                        <code>{"user_name": null, "time_of_day": "afternoon"}</code>
                                                    </div>
                                                    <div class="tool-result text-success">
                                                        <i class="bi bi-check-circle me-1"></i> Success
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="observability-section">
                                        <h6 class="section-title">
                                            <i class="bi bi-tag me-2"></i>
                                            Entities Extracted
                                        </h6>
                                        <div class="section-content">
                                            <div class="entity-extraction">
                                                <div class="entity-list">
                                                    <span class="badge bg-secondary">No entities detected</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="observability-placeholder text-center py-5" id="observability-placeholder">
                                    <i class="bi bi-eye display-1 text-muted mb-3"></i>
                                    <h5>Select a message to view details</h5>
                                    <p class="text-muted">Click "View Details" on any chat message to see observability data</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="agents-tab-pane" role="tabpanel" aria-labelledby="agents-tab" tabindex="0">
                <h3 class="mb-4">All Agents</h3>
                
                <div id="agents-connection-alert" class="connection-issue" style="display: none;">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
                        <span>Unable to fetch live agent data. Showing cached data instead.</span>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody id="agents-table-body">
                            <!-- Agent list will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-pane fade" id="builder-tab-pane" role="tabpanel" aria-labelledby="builder-tab" tabindex="0">
                <h3 class="mb-4">Agent Builder</h3>
                
                <div class="agent-builder-container">
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Create New Agent</h5>
                                    <p class="card-text">Build custom agents with specialized capabilities for customer engagement scenarios.</p>
                                    <button class="btn btn-primary mt-3" disabled>
                                        <i class="bi bi-plus-circle me-2"></i>
                                        New Agent
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="agent-builder-placeholder">
                        <div class="text-center">
                            <i class="bi bi-gear display-1 text-muted mb-3"></i>
                            <h4>Agent Builder Coming Soon</h4>
                            <p class="text-muted">This feature is currently under development.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            </div>
            <!-- End Tab Content -->
        </main>
        <!-- End Main Content Area -->
        
        <footer class="footer mt-auto py-3">
            <div class="container">
                <p class="text-muted text-center mb-0">Staples Brain • AI Customer Engagement Platform • April 2025</p>
            </div>
        </footer>
    </div>
    <!-- End App Container -->
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Agent data - This would normally come from the API
            const agents = [
                { 
                    id: 'f2feabb7-2279-4feb-875a-3c7f58105ac9',
                    name: 'Guardrails Agent', 
                    type: 'SYSTEM', 
                    description: 'Enforces system guardrails and safety constraints for all conversations.',
                    status: 'active',
                    is_system: true
                },
                { 
                    id: 'd5e22e3a-1d83-49bf-baef-52c8f4d55a87',
                    name: 'General Conversation Agent', 
                    type: 'SYSTEM', 
                    description: 'Handles general conversational flows and fallback responses.',
                    status: 'active',
                    is_system: true
                },
                { 
                    id: '6929f621-de11-4068-9d4b-5160a9b4e85f',
                    name: 'Package Tracking Agent', 
                    type: 'PACKAGE_TRACKING', 
                    description: 'Provides order status and package tracking information to customers.',
                    status: 'active',
                    is_system: false
                },
                { 
                    id: 'ded3cb1c-6db4-4337-9b8a-c80668d14de3',
                    name: 'Reset Password Agent', 
                    type: 'RESET_PASSWORD', 
                    description: 'Guides users through the process of resetting their account passwords.',
                    status: 'active',
                    is_system: false
                },
                { 
                    id: '1ed554e4-8843-405a-ab3e-83866eb262bf',
                    name: 'Store Locator Agent', 
                    type: 'STORE_LOCATOR', 
                    description: 'Helps users find the nearest Staples store locations based on geographic queries.',
                    status: 'active',
                    is_system: false
                },
                { 
                    id: '4525be42-73cf-4fee-990c-3622c4baaaa3',
                    name: 'Product Information Agent', 
                    type: 'PRODUCT_INFO', 
                    description: 'Provides detailed information about product specifications, pricing, and availability.',
                    status: 'active',
                    is_system: false
                },
                { 
                    id: '247b2b9c-17d6-4513-8375-e2275d1f1e78',
                    name: 'Returns Processing Agent', 
                    type: 'RETURNS_PROCESSING', 
                    description: 'Assists customers with product returns and exchange procedures.',
                    status: 'active',
                    is_system: false
                }
            ];
            
            // Update agent count in stats
            document.getElementById('agent-count').textContent = agents.length;
            
            // Show connection alert since we're using static data instead of API
            document.getElementById('agent-connection-alert').style.display = 'block';
            document.getElementById('agents-connection-alert').style.display = 'block';
            
            // Function to get type badge color
            function getTypeBadgeColor(type) {
                const typeMap = {
                    'SYSTEM': 'bg-dark',
                    'PACKAGE_TRACKING': 'bg-primary',
                    'RESET_PASSWORD': 'bg-danger',
                    'STORE_LOCATOR': 'bg-success',
                    'PRODUCT_INFO': 'bg-info',
                    'RETURNS_PROCESSING': 'bg-warning'
                };
                return typeMap[type] || 'bg-secondary';
            }
            
            // Function to format agent type for display
            function formatAgentType(type) {
                return type.split('_').map(word => 
                    word.charAt(0) + word.slice(1).toLowerCase()
                ).join(' ');
            }
            
            // Load agent cards for dashboard
            const agentCardsContainer = document.getElementById('agent-cards-container');
            
            // Filter out system agents for the dashboard cards
            const specializedAgents = agents.filter(agent => !agent.is_system);
            
            specializedAgents.forEach(agent => {
                const cardHtml = `
                    <div class="col-lg-4 col-md-6">
                        <div class="card agent-card h-100 position-relative">
                            <span class="badge ${getTypeBadgeColor(agent.type)} agent-type-badge">${formatAgentType(agent.type)}</span>
                            <div class="card-body">
                                <h5 class="card-title">${agent.name}</h5>
                                <p class="card-text">${agent.description}</p>
                                <span class="badge bg-success">Active</span>
                            </div>
                        </div>
                    </div>
                `;
                agentCardsContainer.innerHTML += cardHtml;
            });
            
            // Load agent list for Agents tab
            const agentsTableBody = document.getElementById('agents-table-body');
            
            agents.forEach(agent => {
                const statusBadge = agent.status === 'active' ? 
                    '<span class="badge bg-success">Active</span>' : 
                    '<span class="badge bg-secondary">Inactive</span>';
                
                const typeBadge = `<span class="badge ${getTypeBadgeColor(agent.type)}">${formatAgentType(agent.type)}</span>`;
                
                const rowHtml = `
                    <tr>
                        <td>${agent.name}</td>
                        <td>${typeBadge}</td>
                        <td>${statusBadge}</td>
                        <td>${agent.description}</td>
                    </tr>
                `;
                agentsTableBody.innerHTML += rowHtml;
            });
            
            // Chat and Observability functionality
            const embeddedChatForm = document.getElementById('embedded-chat-form');
            const embeddedChatInput = document.getElementById('embedded-chat-input');
            const embeddedChatMessages = document.getElementById('embedded-chat-messages');
            const chatConnectionStatus = document.getElementById('chat-connection-status');
            const launchChatBtn = document.getElementById('launch-chat-btn');
            const toggleObservabilityBtn = document.getElementById('toggle-observability');
            const chatPanel = document.getElementById('chat-panel');
            const observabilityPanel = document.getElementById('observability-panel');
            const observabilityContent = document.getElementById('observability-content');
            const observabilityPlaceholder = document.getElementById('observability-placeholder');
            
            // Variables
            let currentConversationId = 'conv_' + Date.now();
            let isObservabilityVisible = true;
            let messageCounter = 1;
            
            // Switch to chat tab when launch chat button is clicked
            launchChatBtn.addEventListener('click', () => {
                const chatTab = new bootstrap.Tab(document.getElementById('chat-tab'));
                chatTab.show();
                setTimeout(() => embeddedChatInput.focus(), 300);
            });
            
            // Toggle observability panel
            toggleObservabilityBtn.addEventListener('click', () => {
                isObservabilityVisible = !isObservabilityVisible;
                if (isObservabilityVisible) {
                    observabilityPanel.style.display = 'block';
                    chatPanel.style.flex = '1';
                    toggleObservabilityBtn.innerHTML = '<i class="bi bi-layout-split"></i> <span>Hide Observability</span>';
                } else {
                    observabilityPanel.style.display = 'none';
                    chatPanel.style.flex = '2';
                    toggleObservabilityBtn.innerHTML = '<i class="bi bi-layout-split"></i> <span>Show Observability</span>';
                }
            });
            
            // Initialize event delegation for observability toggles
            document.addEventListener('click', function(e) {
                if (e.target && e.target.closest('.observability-msg-toggle')) {
                    const toggleBtn = e.target.closest('.observability-msg-toggle');
                    const messageId = toggleBtn.getAttribute('data-message-id');
                    showObservabilityDetails(messageId);
                    
                    // Mark the message as selected
                    document.querySelectorAll('.message').forEach(msg => {
                        msg.classList.remove('selected');
                    });
                    document.querySelector(`.message[data-message-id="${messageId}"]`).classList.add('selected');
                }
            });
            
            // Show observability details for a specific message
            function showObservabilityDetails(messageId) {
                // Hide placeholder and show the relevant observability data
                observabilityPlaceholder.classList.add('hidden');
                
                // Hide all observability messages
                document.querySelectorAll('.observability-message').forEach(msg => {
                    msg.classList.remove('active');
                });
                
                // Show the selected message's observability data
                const obsMessage = document.getElementById(`obs-${messageId}`);
                if (obsMessage) {
                    obsMessage.classList.add('active');
                } else {
                    // If there's no existing observability data, fetch it from the API
                    fetchObservabilityData(messageId);
                }
            }
            
            // Fetch observability data from API for a specific message
            function fetchObservabilityData(messageId) {
                // Hide placeholder and show the relevant observability data
                observabilityPlaceholder.classList.add('hidden');
                
                // Create and append observability data container
                const obsMessageDiv = document.createElement('div');
                obsMessageDiv.id = `obs-${messageId}`;
                obsMessageDiv.className = 'observability-message active loading';
                obsMessageDiv.innerHTML = '<div class="text-center my-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading observability data...</p></div>';
                
                // Add to the observability content area
                observabilityContent.appendChild(obsMessageDiv);
                
                // Fetch from API if we have a trace ID
                fetchObservabilityDataFromApi(null, messageId);
            }
            
            // Fetch observability data from API using trace ID
            async function fetchObservabilityDataFromApi(traceId, messageId) {
                try {
                    let url;
                    if (traceId) {
                        // If we have a trace ID, use it
                        url = `/api/v1/chat/observability/${traceId}`;
                    } else {
                        // Otherwise use the conversation ID
                        url = `/api/v1/chat/observability/${currentConversationId}?message_id=${messageId}`;
                    }
                    
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.error || 'Unknown error fetching observability data');
                    }
                    
                    // Get element ID to update
                    const elementId = messageId ? `obs-${messageId}` : `obs-latest`;
                    const obsElement = document.getElementById(elementId);
                    
                    if (obsElement) {
                        // Format and display observability data
                        const formattedData = formatObservabilityData(data.data);
                        obsElement.innerHTML = formattedData;
                        obsElement.classList.remove('loading');
                    }
                } catch (error) {
                    console.error('Error fetching observability data:', error);
                    
                    // Show error in observability panel
                    const elementId = messageId ? `obs-${messageId}` : `obs-latest`;
                    const obsElement = document.getElementById(elementId);
                    
                    if (obsElement) {
                        obsElement.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                Error loading observability data: ${error.message}
                            </div>
                        `;
                        obsElement.classList.remove('loading');
                    }
                }
            }
            
            // Format observability data from API response
            function formatObservabilityData(data) {
                // If no data, show message
                if (!data || Object.keys(data).length === 0) {
                    return `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            No observability data available for this message.
                        </div>
                    `;
                }
                
                // Format agent selection data
                const agentSelectionHtml = formatAgentSelectionFlow(data.agent_selection || {});
                
                // Format tools execution data
                const toolsHtml = formatToolsExecuted(data.tools_executed || []);
                
                // Format entities data
                const entitiesHtml = formatEntitiesExtracted(data.entities || []);
                
                // Full observability HTML
                return `
                    <div class="observability-section mb-4">
                        <h6 class="section-title">
                            <i class="bi bi-robot me-2"></i>
                            Agent Selection
                        </h6>
                        <div class="section-content">
                            ${agentSelectionHtml}
                        </div>
                    </div>
                    
                    ${toolsHtml}
                    
                    <div class="observability-section">
                        <h6 class="section-title">
                            <i class="bi bi-tag me-2"></i>
                            Entities Extracted
                        </h6>
                        <div class="section-content">
                            <div class="entity-extraction">
                                <div class="entity-list">
                                    ${entitiesHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Format agent selection flow
            function formatAgentSelectionFlow(agentSelection) {
                if (!agentSelection || !agentSelection.agents || agentSelection.agents.length === 0) {
                    return '<div class="alert alert-info">No agent selection data available.</div>';
                }
                
                let html = '<div class="agent-selection-flow">';
                
                agentSelection.agents.forEach((agent, index) => {
                    // Only add arrow if not the first agent
                    if (index > 0) {
                        html += '<div class="flow-arrow">→</div>';
                    }
                    
                    // Determine if agent was selected
                    const isSelected = agent.selected || false;
                    
                    html += `
                        <div class="agent-node ${isSelected ? 'selected' : ''}">
                            <div class="agent-icon">
                                <i class="bi bi-${agent.icon || 'chat-dots'}"></i>
                            </div>
                            <div class="agent-info">
                                <div class="agent-name">${agent.name || 'Unknown Agent'}</div>
                                <div class="agent-description small">${agent.description || ''}</div>
                                ${agent.confidence ? `<div class="agent-confidence small">Confidence: ${(agent.confidence * 100).toFixed(1)}%</div>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                return html;
            }
            
            // Format tools executed
            function formatToolsExecuted(tools) {
                if (!tools || tools.length === 0) {
                    return '';
                }
                
                let toolsHtml = `
                    <div class="observability-section mb-4">
                        <h6 class="section-title">
                            <i class="bi bi-tools me-2"></i>
                            Tools Executed
                        </h6>
                        <div class="section-content">
                `;
                
                tools.forEach(tool => {
                    toolsHtml += `
                        <div class="tool-execution">
                            <div class="tool-name">${tool.name || 'Unknown Tool'}</div>
                            <div class="tool-details small">
                                <div class="tool-params">
                                    <code>${JSON.stringify(tool.parameters || {})}</code>
                                </div>
                                <div class="tool-result ${tool.success ? 'text-success' : 'text-danger'}">
                                    <i class="bi bi-${tool.success ? 'check-circle' : 'x-circle'} me-1"></i>
                                    ${tool.success ? 'Success' : 'Failed'}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                toolsHtml += `
                        </div>
                    </div>
                `;
                
                return toolsHtml;
            }
            
            // Format entities extracted
            function formatEntitiesExtracted(entities) {
                if (!entities || entities.length === 0) {
                    return '<span class="badge bg-secondary">No entities detected</span>';
                }
                
                return entities.map(entity => {
                    return `<span class="badge bg-info me-1">${entity.value || entity.name} <span class="badge bg-dark ms-1">${entity.type || 'unknown'}</span></span>`;
                }).join('');
            }
            
            // Create simulated observability data for demo purposes
            function createSimulatedObservabilityData(messageId) {
                const message = document.querySelector(`[data-message-id="${messageId}"]`);
                const isAssistant = message.classList.contains('message-assistant');
                const messageText = message.querySelector('.message-content').textContent;
                const agentName = isAssistant ? message.querySelector('.agent-badge .badge').textContent : 'User';
                
                // Analysis data for different message types
                const possibleEntities = [
                    'Staples Business Card (product)',
                    'Boston, MA (location)',
                    'Printer Ink (product_category)',
                    'Order #ST-123456 (order)',
                    'John Smith (customer)',
                    'Credit Card (payment_method)',
                    'Tomorrow (datetime)',
                    'Customer Support (department)'
                ];
                
                // Randomly decide if entities were detected
                const hasEntities = Math.random() > 0.5;
                const numberOfEntities = hasEntities ? Math.floor(Math.random() * 3) + 1 : 0;
                
                // Pick random entities
                const entities = [];
                if (hasEntities) {
                    const shuffled = [...possibleEntities].sort(() => 0.5 - Math.random());
                    for (let i = 0; i < numberOfEntities; i++) {
                        entities.push(shuffled[i]);
                    }
                }
                
                // Create HTML for entities
                let entitiesHtml = '';
                if (entities.length > 0) {
                    entitiesHtml = entities.map(entity => {
                        const [name, type] = entity.split(' (');
                        const cleanType = type.replace(')', '');
                        return `<span class="badge bg-info me-1">${name} <span class="badge bg-dark ms-1">${cleanType}</span></span>`;
                    }).join('');
                } else {
                    entitiesHtml = '<span class="badge bg-secondary">No entities detected</span>';
                }
                
                // Determine which agents were involved based on message
                const agentSelectionHtml = isAssistant ? `
                    <div class="agent-selection-flow">
                        <div class="agent-node selected">
                            <div class="agent-icon">
                                <i class="bi bi-shield-check"></i>
                            </div>
                            <div class="agent-info">
                                <div class="agent-name">Guardrails Agent</div>
                                <div class="agent-description small">Safety validation passed</div>
                            </div>
                        </div>
                        <div class="flow-arrow">→</div>
                        <div class="agent-node selected">
                            <div class="agent-icon">
                                <i class="bi bi-chat-dots"></i>
                            </div>
                            <div class="agent-info">
                                <div class="agent-name">${agentName}</div>
                                <div class="agent-description small">Primary responding agent</div>
                            </div>
                        </div>
                    </div>
                ` : `
                    <div class="agent-selection-flow">
                        <div class="agent-node">
                            <div class="agent-icon">
                                <i class="bi bi-person"></i>
                            </div>
                            <div class="agent-info">
                                <div class="agent-name">User</div>
                                <div class="agent-description small">User message</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Tools executed (only for assistant messages)
                const toolsHtml = isAssistant ? `
                    <div class="observability-section mb-4">
                        <h6 class="section-title">
                            <i class="bi bi-tools me-2"></i>
                            Tools Executed
                        </h6>
                        <div class="section-content">
                            <div class="tool-execution">
                                <div class="tool-name">${agentName}ResponseGenerator</div>
                                <div class="tool-details small">
                                    <div class="tool-params">
                                        <code>{"user_query": "${messageText.substring(0, 50)}${messageText.length > 50 ? '...' : ''}", "expected_response_type": "text"}</code>
                                    </div>
                                    <div class="tool-result text-success">
                                        <i class="bi bi-check-circle me-1"></i> Success
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                ` : '';
                
                // Full observability HTML
                return `
                    <div class="observability-section mb-4">
                        <h6 class="section-title">
                            <i class="bi bi-robot me-2"></i>
                            Agent Selection
                        </h6>
                        <div class="section-content">
                            ${agentSelectionHtml}
                        </div>
                    </div>
                    
                    ${toolsHtml}
                    
                    <div class="observability-section">
                        <h6 class="section-title">
                            <i class="bi bi-tag me-2"></i>
                            Entities Extracted
                        </h6>
                        <div class="section-content">
                            <div class="entity-extraction">
                                <div class="entity-list">
                                    ${entitiesHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Add message to chat UI
            function addMessageToChat(role, content, metadata = {}) {
                const messageId = `msg-${Date.now()}-${messageCounter++}`;
                const time = new Date().toLocaleTimeString();
                
                // Format message content (simple markdown-like support)
                let formattedContent = content;
                // Basic markdown support - code blocks
                formattedContent = formattedContent.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
                // Basic markdown support - inline code
                formattedContent = formattedContent.replace(/`([^`]+)`/g, '<code>$1</code>');
                
                // Create the badge for assistant messages
                const agentBadge = role === 'assistant' && metadata.agent ? 
                    `<div class="agent-badge">
                        <span class="badge bg-info">${metadata.agent}</span>
                    </div>` : '';
                
                // Create the message HTML
                const messageHtml = `
                    <div class="message message-${role}" data-message-id="${messageId}">
                        <div class="message-header d-flex justify-content-between align-items-start mb-2">
                            ${agentBadge}
                            <button class="btn btn-sm btn-link text-muted observability-msg-toggle" data-message-id="${messageId}">
                                <i class="bi bi-eye-fill"></i> View Details
                            </button>
                        </div>
                        <div class="message-content">${formattedContent}</div>
                        <div class="text-muted small mt-1">${time}</div>
                    </div>
                `;
                
                // Add to the chat
                embeddedChatMessages.insertAdjacentHTML('beforeend', messageHtml);
                
                // Scroll to bottom
                embeddedChatMessages.scrollTop = embeddedChatMessages.scrollHeight;
                
                return messageId;
            }
            
            // Handle chat form submission
            embeddedChatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const message = embeddedChatInput.value.trim();
                if (!message) return;
                
                // Add user message to UI
                const userMessageId = addMessageToChat('user', message);
                embeddedChatInput.value = '';
                
                // Update connection status
                chatConnectionStatus.innerHTML = '<span class="status-indicator status-sending"></span> Sending...';
                chatConnectionStatus.className = 'badge bg-warning';
                
                try {
                    // Prepare request to backend API
                    const response = await fetch('/api/v1/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            session_id: currentConversationId,
                            context: {
                                // Additional context if needed
                                client_info: {
                                    app: 'staples-brain-dashboard',
                                    version: '1.0.0'
                                }
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log("Response data from API:", data);
                    
                    if (!data.success) {
                        throw new Error(data.error || 'Unknown error processing message');
                    }
                    
                    // Extract response data
                    const responseData = data.data;
                    const agentName = responseData.agent || 'Assistant';
                    const responseText = responseData.message || 'No response';
                    
                    // Add response to UI
                    const assistantMessageId = addMessageToChat('assistant', responseText, { agent: agentName });
                    
                    // Reset connection status
                    chatConnectionStatus.innerHTML = '<span class="status-indicator status-connected"></span> Connected';
                    chatConnectionStatus.className = 'badge bg-success';
                    
                    // Fetch observability data if available
                    if (responseData.observability_trace_id) {
                        await fetchObservabilityDataFromApi(responseData.observability_trace_id);
                    }
                    
                } catch (error) {
                    console.error('Error processing message:', error);
                    
                    // Show connection error
                    chatConnectionStatus.innerHTML = '<span class="status-indicator status-error"></span> Backend Unavailable';
                    chatConnectionStatus.className = 'badge bg-danger';
                    
                    // Add warning about backend unavailability
                    addMessageToChat('system', `The backend server is currently unavailable. Using fallback mode with limited functionality.`);
                    
                    // Use fallback response for testing purposes
                    const fallbackResponse = getFallbackResponse(message, currentConversationId);
                    
                    // Add fallback response
                    const assistantMessageId = addMessageToChat('assistant', fallbackResponse.message, { 
                        agent: fallbackResponse.agent 
                    });
                    
                    // Generate fallback observability data
                    setTimeout(() => {
                        const obsData = {
                            agent_selection: {
                                agents: [
                                    {
                                        name: "User",
                                        icon: "person",
                                        description: "User message",
                                        selected: false
                                    },
                                    {
                                        name: fallbackResponse.agent,
                                        icon: "chat-dots",
                                        description: "Primary responding agent (fallback mode)",
                                        confidence: 0.8,
                                        selected: true
                                    }
                                ]
                            },
                            tools_executed: [
                                {
                                    name: "LocalFallbackResponseGenerator",
                                    parameters: {
                                        "message": message.substring(0, 50) + (message.length > 50 ? "..." : "")
                                    },
                                    success: true
                                }
                            ],
                            entities: fallbackResponse.entities || []
                        };
                        
                        // Create observability container
                        const obsMessageDiv = document.createElement('div');
                        obsMessageDiv.id = `obs-${assistantMessageId}`;
                        obsMessageDiv.className = 'observability-message active';
                        obsMessageDiv.innerHTML = formatObservabilityData(obsData);
                        
                        // Add to observability content and hide placeholder
                        observabilityContent.appendChild(obsMessageDiv);
                        observabilityPlaceholder.classList.add('hidden');
                        
                        // Mark message as selected
                        document.querySelectorAll('.message').forEach(msg => {
                            msg.classList.remove('selected');
                        });
                        document.querySelector(`.message[data-message-id="${assistantMessageId}"]`).classList.add('selected');
                    }, 500);
                }
                
                // Fallback function for when backend is unavailable
                function getFallbackResponse(message, conversationId) {
                    // Get last message in conversation for context
                    const messages = document.querySelectorAll('.message');
                    const lastMessages = Array.from(messages).slice(-5);
                    
                    // For password reset flow, check if previous message was about password reset
                    const hasPreviousPasswordResetMessage = lastMessages.some(msg => {
                        const content = msg.querySelector('.message-content')?.textContent || '';
                        const agentBadge = msg.querySelector('.agent-badge .badge')?.textContent || '';
                        return agentBadge === 'Reset Password Agent' && content.toLowerCase().includes('email');
                    });
                    
                    // For email response to password reset agent
                    if (hasPreviousPasswordResetMessage && message.includes('@')) {
                        return {
                            message: `Thank you for confirming your email address (${message}). I've sent a password reset link to this email. Please check your inbox and follow the instructions in the email to reset your password. The link will expire in 24 hours.`,
                            agent: "Reset Password Agent",
                            entities: [
                                { value: message, type: "email_address" }
                            ]
                        };
                    }
                    
                    // Standard keyword-based routing
                    if (message.toLowerCase().includes('track') || message.toLowerCase().includes('package') || message.toLowerCase().includes('order')) {
                        return {
                            message: "I can help you track your package. Could you please provide your order number?",
                            agent: "Package Tracking Agent",
                            entities: []
                        };
                    } else if (message.toLowerCase().includes('password') || message.toLowerCase().includes('reset')) {
                        return {
                            message: "I can help you reset your password. For security reasons, I'll need to verify your identity first. Could you please confirm the email address associated with your account?",
                            agent: "Reset Password Agent", 
                            entities: []
                        };
                    } else if (message.toLowerCase().includes('store') || message.toLowerCase().includes('location')) {
                        return {
                            message: "I can help you find the nearest Staples store. Could you please share your zip code or city and state?",
                            agent: "Store Locator Agent",
                            entities: []
                        };
                    } else if (message.toLowerCase().includes('product') || message.toLowerCase().includes('item')) {
                        return { 
                            message: "I'd be happy to provide information about our products. Which specific item are you interested in?",
                            agent: "Product Information Agent",
                            entities: []
                        };
                    } else if (message.toLowerCase().includes('return') || message.toLowerCase().includes('exchange')) {
                        return {
                            message: "I can help with your return or exchange. Do you have your order number and the item you'd like to return?",
                            agent: "Returns Processing Agent",
                            entities: []
                        };
                    } else {
                        return {
                            message: "Thanks for your message. I notice the backend server is currently unavailable. Once it's back online, I'll be able to provide more comprehensive assistance.",
                            agent: "General Conversation Agent",
                            entities: []
                        };
                    }
                }
            });
        });
    </script>
</body>
</html>