<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staples Brain - Chat with Observability</title>
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            min-height: 100vh;
            overflow: hidden;
        }
        
        .container-fluid {
            height: 100vh;
            padding: 0;
        }
        
        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .observability-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        
        .chat-header, .observability-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            max-width: 80%;
        }
        
        .message-user {
            background-color: rgba(13, 110, 253, 0.2);
            align-self: flex-end;
            margin-left: auto;
        }
        
        .message-assistant {
            background-color: rgba(32, 32, 32, 0.5);
            align-self: flex-start;
        }
        
        .agent-badge {
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .status-connected {
            background-color: var(--bs-success);
        }
        
        .status-disconnected {
            background-color: var(--bs-danger);
        }
        
        .status-sending {
            background-color: var(--bs-warning);
        }
        
        /* Observability Panel Styles */
        .observability-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .agent-card {
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .agent-card.active {
            border-color: var(--bs-primary);
            background-color: rgba(13, 110, 253, 0.1);
        }
        
        .agent-card.processing {
            border-color: var(--bs-warning);
            background-color: rgba(255, 193, 7, 0.1);
        }
        
        .agent-card.selected {
            border-color: var(--bs-success);
            background-color: rgba(25, 135, 84, 0.1);
        }
        
        .agent-stats {
            font-size: 0.875rem;
        }
        
        .nav-tabs .nav-link.active {
            background-color: rgba(13, 110, 253, 0.2);
            border-color: transparent;
            color: white;
        }
        
        .tab-content {
            padding: 1rem 0;
        }
        
        .log-entry {
            font-family: monospace;
            font-size: 0.875rem;
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .event-timeline {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
        }
        
        .timeline-item {
            position: relative;
            padding: 12px 15px;
            margin-bottom: 0.5rem;
            border-left: 3px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
            border-radius: 0 4px 4px 0;
        }
        
        .timeline-item:hover {
            background-color: rgba(0, 0, 0, 0.2);
        }
        
        .timeline-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
            margin-right: 8px;
        }
        
        .timeline-source {
            font-size: 0.8rem;
        }
        
        .timeline-content {
            margin: 5px 0;
            padding-left: 32px;
        }
        
        .timeline-details {
            margin-top: 8px;
        }
        
        .timeline-time {
            font-size: 0.75rem;
            color: var(--bs-secondary);
        }
        
        .collapse-toggle {
            transition: transform 0.2s ease;
            color: var(--bs-light);
            cursor: pointer;
        }
        
        .collapse-toggle[aria-expanded="true"] .bi-chevron-down {
            transform: rotate(180deg);
        }
        
        /* Graph visualization styles */
        .graph-container {
            width: 100%;
            height: 300px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .graph-node {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: rgba(13, 110, 253, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .graph-node.active {
            border-color: var(--bs-warning);
            background-color: rgba(255, 193, 7, 0.3);
        }
        
        .graph-node.selected {
            border-color: var(--bs-success);
            background-color: rgba(25, 135, 84, 0.3);
        }
        
        .graph-edge {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.2);
            transform-origin: 0 0;
            z-index: -1;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row g-0">
            <!-- Chat Panel - Left Side -->
            <div class="col-md-7">
                <div class="chat-container">
                    <div class="chat-header d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">Staples Brain</h4>
                            <div class="text-muted small">AI Customer Assistant</div>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="me-2">Status:</span>
                            <span class="badge bg-success" id="connection-status">
                                <span class="status-indicator status-connected"></span>
                                Connected
                            </span>
                            <a href="/" class="btn btn-sm btn-outline-secondary ms-3">
                                <i class="bi bi-house"></i> Dashboard
                            </a>
                        </div>
                    </div>
                    
                    <div class="chat-messages" id="chat-messages">
                        <!-- Messages will be added here -->
                        <div class="message message-assistant">
                            <div class="agent-badge">
                                <span class="badge bg-info">System</span>
                            </div>
                            <div>Hello! I'm the Staples Brain assistant. How can I help you today?</div>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <form id="chat-form" class="d-flex">
                            <input type="text" id="chat-input" class="form-control me-2" placeholder="Type your message..." autocomplete="off">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Observability Panel - Right Side -->
            <div class="col-md-5">
                <div class="observability-container">
                    <div class="observability-header">
                        <h4 class="mb-0">Agent Observability</h4>
                        <div class="text-muted small">Real-time processing visualization</div>
                    </div>
                    
                    <div class="observability-content">
                        <ul class="nav nav-tabs" id="observabilityTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="agents-tab" data-bs-toggle="tab" data-bs-target="#agents" type="button" role="tab" aria-controls="agents" aria-selected="true">
                                    <i class="bi bi-person-badge"></i> Agents
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="graph-tab" data-bs-toggle="tab" data-bs-target="#graph" type="button" role="tab" aria-controls="graph" aria-selected="false">
                                    <i class="bi bi-diagram-3"></i> Graph
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab" aria-controls="logs" aria-selected="false">
                                    <i class="bi bi-journal-text"></i> Logs
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline" type="button" role="tab" aria-controls="timeline" aria-selected="false">
                                    <i class="bi bi-clock-history"></i> Timeline
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="observabilityTabContent">
                            <!-- Agents Tab -->
                            <div class="tab-pane fade show active" id="agents" role="tabpanel" aria-labelledby="agents-tab">
                                <div id="agents-list">
                                    <!-- Agent cards will be added here -->
                                </div>
                            </div>
                            
                            <!-- Graph Tab -->
                            <div class="tab-pane fade" id="graph" role="tabpanel" aria-labelledby="graph-tab">
                                <div class="graph-container" id="graph-visualization">
                                    <!-- Graph visualization will be rendered here -->
                                </div>
                                <div class="card bg-dark">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Graph Details</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="graph-details">
                                            Select a node to see details
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Logs Tab -->
                            <div class="tab-pane fade" id="logs" role="tabpanel" aria-labelledby="logs-tab">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0">Processing Logs</h5>
                                    <button class="btn btn-sm btn-outline-secondary" id="clear-logs">
                                        <i class="bi bi-trash"></i> Clear
                                    </button>
                                </div>
                                <div id="logs-content" class="logs-content">
                                    <!-- Logs will be added here -->
                                    <div class="log-entry">
                                        <span class="text-muted">[System]</span> Observability panel initialized
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Timeline Tab -->
                            <div class="tab-pane fade" id="timeline" role="tabpanel" aria-labelledby="timeline-tab">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0">Event Timeline</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" id="timeline-to-agent" 
                                                title="Link selected event to agent view">
                                            <i class="bi bi-link"></i> Link to Agents
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" id="clear-timeline">
                                            <i class="bi bi-trash"></i> Clear
                                        </button>
                                    </div>
                                </div>
                                <div class="event-timeline" id="event-timeline">
                                    <!-- Timeline events will be added here dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const connectionStatus = document.getElementById('connection-status');
        const agentsList = document.getElementById('agents-list');
        const logsContent = document.getElementById('logs-content');
        const eventTimeline = document.getElementById('event-timeline');
        const graphVisualization = document.getElementById('graph-visualization');
        
        // Variables
        let currentConversationId = 'conv_' + Date.now();
        let agents = [];
        let messageCounter = 0;

        // Bootstrap tabs initialization
        document.addEventListener('DOMContentLoaded', () => {
            // Load all Bootstrap tabs - requires Bootstrap JS
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js';
            script.integrity = 'sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz';
            script.crossOrigin = 'anonymous';
            document.head.appendChild(script);
            
            // Focus the input field when the page loads
            chatInput.focus();
            
            // Load available agents
            fetchAgentList();
            
            // Add initial timeline event
            addTimelineEvent('Conversation started', 'System');
        });
        
        chatForm.addEventListener('submit', handleChatSubmit);
        
        // Functions
        function handleChatSubmit(e) {
            e.preventDefault();
            const message = chatInput.value.trim();
            if (!message) return;
            
            // Generate a unique message ID
            const messageId = `msg-${Date.now()}-${messageCounter++}`;
            
            // Add user message to UI
            addMessageToUI('user', message, {
                timestamp: new Date().toISOString(),
                messageId: messageId
            });
            chatInput.value = '';
            
            // Update status to sending
            updateConnectionStatus('sending');
            
            // Add to logs and timeline
            addLog(`User sent message: "${message.substring(0, 30)}${message.length > 30 ? '...' : ''}"`);
            addTimelineEvent(`Message sent: "${message.substring(0, 30)}${message.length > 30 ? '...' : ''}"`, 'User');
            
            // Send message to backend
            sendMessageToBackend(message, messageId);
        }
        
        function addMessageToUI(role, content, metadata = {}) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${role}`;
            if (metadata.messageId) {
                messageDiv.setAttribute('data-message-id', metadata.messageId);
            }
            
            let messageContent = '';
            
            // For assistant messages, add the agent name as a badge if available
            if (role === 'assistant' && metadata.agent) {
                messageContent += `
                    <div class="agent-badge">
                        <span class="badge bg-info">${metadata.agent}</span>
                    </div>
                `;
            }
            
            // Format message content (simple markdown-like support)
            let formattedContent = content;
            // Basic markdown support - code blocks
            formattedContent = formattedContent.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            // Basic markdown support - inline code
            formattedContent = formattedContent.replace(/`([^`]+)`/g, '<code>$1</code>');
            // Basic markdown support - bold
            formattedContent = formattedContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Add a details button for assistant messages to view in observability panel
            let detailsButton = '';
            if (role === 'assistant' && metadata.messageId) {
                detailsButton = `
                    <button type="button" class="btn btn-sm btn-outline-info float-end observability-toggle" 
                            data-message-id="${metadata.messageId}" onclick="showMessageObservability('${metadata.messageId}')">
                        <i class="bi bi-eye"></i> Details
                    </button>
                `;
            }
            
            messageContent += `
                <div class="message-header d-flex justify-content-between">
                    ${role === 'user' ? '<strong>You</strong>' : ''}
                    ${detailsButton}
                </div>
                <div class="message-content">${formattedContent}</div>
            `;
            
            // Add timestamp if available
            if (metadata.timestamp) {
                const time = new Date(metadata.timestamp).toLocaleTimeString();
                messageContent += `<div class="text-muted small mt-1">${time}</div>`;
            }
            
            messageDiv.innerHTML = messageContent;
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // If this is an assistant message, create observability data
            if (role === 'assistant' && metadata.agent) {
                // Create agent selection visualization
                createMessageObservability(metadata.messageId, metadata.agent, content);
            }
        }
        
        function sendMessageToBackend(message, messageId) {
            // Prepare the request data
            const requestData = {
                message: message,
                session_id: currentConversationId
            };
            
            // Log request details
            console.log('Sending chat message to API:', requestData);
            
            // Add to logs
            addLog('Sending message to API...');
            
            // Make the API call to the backend - direct to the main API router endpoint
            fetch('/api/v1/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'Cache-Control': 'no-cache'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('API response:', data);
                
                // Update connection status to connected
                updateConnectionStatus('connected');
                
                if (data.success) {
                    // Add to logs
                    addLog(`Received response from agent: ${data.agent || 'Unknown'}`);
                    
                    // Add to timeline
                    addTimelineEvent(`Response received from ${data.agent || 'System'}`, data.agent || 'System');
                    
                    // Update agent status in observability
                    updateAgentStatus(data.agent);
                    
                    // Add the assistant's response to the UI
                    const responseContent = data.response || 'I apologize, but I cannot respond at the moment.';
                    
                    // Generate a unique message ID for the response
                    const responseId = `resp-${Date.now()}-${messageCounter++}`;
                    
                    // Pass the metadata including agent name
                    addMessageToUI('assistant', responseContent, {
                        timestamp: new Date().toISOString(),
                        agent: data.agent,
                        messageId: responseId
                    });
                    
                    // Store the session_id from the response if available
                    if (data.session_id) {
                        currentConversationId = data.session_id;
                    }
                } else {
                    // Handle error response
                    addLog(`Error from API: ${data.error || 'Unknown error'}`);
                    addTimelineEvent('Error receiving response', 'System');
                    
                    // Add error message to UI
                    addMessageToUI('assistant', data.error || 'I apologize, but there was an error processing your request. Please try again.', {
                        timestamp: new Date().toISOString(),
                        messageId: `error-${Date.now()}`
                    });
                    console.error('API error:', data.error);
                }
            })
            .catch(error => {
                console.error('Error sending message:', error);
                
                // Add to logs
                addLog(`Network error: ${error.message}`);
                addTimelineEvent('Network error occurred', 'System');
                
                // Display error message to user
                addMessageToUI('assistant', 'I apologize, but there was a network error. Please check your connection and try again.', {
                    timestamp: new Date().toISOString(),
                    messageId: `error-${Date.now()}`
                });
                
                // Update connection status to error
                updateConnectionStatus('disconnected');
            });
        }
        
        function updateConnectionStatus(status) {
            const statusIndicator = connectionStatus.querySelector('.status-indicator');
            
            switch(status) {
                case 'connected':
                    connectionStatus.className = 'badge bg-success';
                    connectionStatus.innerHTML = '<span class="status-indicator status-connected"></span> Connected';
                    break;
                case 'sending':
                    connectionStatus.className = 'badge bg-warning';
                    connectionStatus.innerHTML = '<span class="status-indicator status-sending"></span> Sending...';
                    break;
                case 'disconnected':
                    connectionStatus.className = 'badge bg-danger';
                    connectionStatus.innerHTML = '<span class="status-indicator status-disconnected"></span> Disconnected';
                    break;
                default:
                    connectionStatus.className = 'badge bg-secondary';
                    connectionStatus.innerHTML = '<span class="status-indicator"></span> Unknown';
            }
        }
        
        // Fetch the list of available agents from the backend
        function fetchAgentList() {
            addLog('Fetching available agents...');
            
            fetch('/api/v1/agents')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Network response was not ok: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.agents) {
                        agents = data.agents;
                        addLog(`Retrieved ${agents.length} agents`);
                        renderAgentCards();
                        renderGraphVisualization();
                    } else {
                        addLog('Error fetching agents: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    addLog('Network error fetching agents: ' + error.message);
                    console.error('Error fetching agents:', error);
                });
        }
        
        // Render agent cards in the observability panel
        function renderAgentCards() {
            if (!agents || agents.length === 0) {
                agentsList.innerHTML = '<div class="alert alert-info">No agents available</div>';
                return;
            }
            
            let html = '';
            
            agents.forEach(agent => {
                const agentType = agent.type ? agent.type.toLowerCase().replace(/_/g, ' ') : 'unknown';
                
                html += `
                    <div class="card agent-card mb-2" data-agent-id="${agent.id}">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <h6 class="card-title mb-1">${agent.name}</h6>
                                <span class="badge bg-secondary">${agentType}</span>
                            </div>
                            <p class="card-text small text-muted mb-2">${agent.description || 'No description available'}</p>
                            <div class="agent-stats d-flex justify-content-between text-muted">
                                <span><i class="bi bi-lightning-charge"></i> Ready</span>
                                <span>${agent.is_system ? 'System Agent' : 'Custom Agent'}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            agentsList.innerHTML = html;
        }
        
        // Update agent status in the UI
        function updateAgentStatus(agentName) {
            if (!agentName || !agents || agents.length === 0) return;
            
            // Find the agent
            const agent = agents.find(a => a.name === agentName);
            if (!agent) return;
            
            // Find the card
            const card = document.querySelector(`.agent-card[data-agent-id="${agent.id}"]`);
            if (!card) return;
            
            // Reset all cards
            document.querySelectorAll('.agent-card').forEach(c => {
                c.classList.remove('active', 'selected');
            });
            
            // Mark this card as selected
            card.classList.add('selected');
            
            // Update the stats
            const stats = card.querySelector('.agent-stats');
            if (stats) {
                stats.innerHTML = `
                    <span><i class="bi bi-check-circle-fill text-success"></i> Selected</span>
                    <span>${new Date().toLocaleTimeString()}</span>
                `;
            }
        }
        
        // Add a log entry to the logs panel
        function addLog(message) {
            const now = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="text-muted">[${now}]</span> ${message}`;
            
            if (logsContent) {
                logsContent.appendChild(logEntry);
                logsContent.scrollTop = logsContent.scrollHeight;
            }
        }
        
        // Add event to the timeline
        function addTimelineEvent(content, source, eventType = 'info', details = null) {
            if (!eventTimeline) return;
            
            // Generate a unique ID for this timeline item
            const eventId = `event-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
            
            // Create the timeline item element
            const timelineItem = document.createElement('div');
            timelineItem.className = 'timeline-item';
            timelineItem.setAttribute('data-event-id', eventId);
            timelineItem.setAttribute('data-source', source);
            timelineItem.setAttribute('data-type', eventType);
            
            // Get current time
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            
            // Determine icon based on event type
            let iconClass = 'bi-info-circle';
            let badgeClass = 'bg-info';
            let iconColor = 'var(--bs-info)';
            
            switch(eventType) {
                case 'user':
                    iconClass = 'bi-person';
                    badgeClass = 'bg-primary';
                    iconColor = 'var(--bs-primary)';
                    break;
                case 'agent':
                    iconClass = 'bi-robot';
                    badgeClass = 'bg-success';
                    iconColor = 'var(--bs-success)';
                    break;
                case 'error':
                    iconClass = 'bi-exclamation-triangle';
                    badgeClass = 'bg-danger';
                    iconColor = 'var(--bs-danger)';
                    break;
                case 'system':
                    iconClass = 'bi-gear';
                    badgeClass = 'bg-secondary';
                    iconColor = 'var(--bs-secondary)';
                    break;
                case 'processing':
                    iconClass = 'bi-arrow-repeat';
                    badgeClass = 'bg-warning';
                    iconColor = 'var(--bs-warning)';
                    break;
                default:
                    iconClass = 'bi-info-circle';
                    badgeClass = 'bg-info';
                    iconColor = 'var(--bs-info)';
            }
            
            // Create expandable details section if details are provided
            let detailsSection = '';
            if (details) {
                detailsSection = `
                    <div class="timeline-details collapse" id="${eventId}-details">
                        <div class="card card-body mt-2 bg-dark">
                            ${typeof details === 'object' ? JSON.stringify(details, null, 2) : details}
                        </div>
                    </div>
                `;
            }
            
            timelineItem.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="timeline-icon" style="background-color: ${iconColor}20; color: ${iconColor}">
                        <i class="bi ${iconClass}"></i>
                    </div>
                    <div class="flex-grow-1 ms-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="timeline-time small text-muted">${timeString}</span>
                                <span class="badge ${badgeClass} ms-2">${source}</span>
                            </div>
                            ${details ? `<button class="btn btn-sm btn-link collapse-toggle p-0" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#${eventId}-details" 
                                    aria-expanded="false" 
                                    aria-controls="${eventId}-details">
                                <i class="bi bi-chevron-down"></i>
                            </button>` : ''}
                        </div>
                        <div class="timeline-content mt-1">${content}</div>
                        ${detailsSection}
                    </div>
                </div>
            `;
            
            // Add click event to select this timeline item
            timelineItem.addEventListener('click', (e) => {
                // Don't trigger selection if clicking on the collapse toggle
                if (e.target.closest('.collapse-toggle')) return;
                
                // Deselect all other timeline items
                document.querySelectorAll('.timeline-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Select this item
                timelineItem.classList.add('selected');
                
                // Log the selection
                addLog(`Selected timeline event: ${content.substring(0, 30)}${content.length > 30 ? '...' : ''}`);
            });
            
            // Append to the end instead of prepending (newest at bottom)
            eventTimeline.appendChild(timelineItem);
            
            // Scroll to the bottom
            eventTimeline.scrollTop = eventTimeline.scrollHeight;
            
            return eventId;
        }
        
        // Render graph visualization
        function renderGraphVisualization() {
            if (!graphVisualization || !agents || agents.length === 0) return;
            
            // Clear existing content
            graphVisualization.innerHTML = '';
            
            // Create nodes based on agents
            agents.forEach((agent, index) => {
                let x = 50 + (index % 3) * 120;
                let y = 50 + Math.floor(index / 3) * 120;
                
                const node = document.createElement('div');
                node.className = 'graph-node';
                node.id = `node-${agent.id}`;
                node.setAttribute('data-agent-id', agent.id);
                node.style.left = `${x}px`;
                node.style.top = `${y}px`;
                node.innerHTML = agent.name;
                
                graphVisualization.appendChild(node);
            });
            
            // Create edges between nodes (simplified for visualization)
            // Connect system agents to all others
            const systemAgents = agents.filter(a => a.is_system);
            const otherAgents = agents.filter(a => !a.is_system);
            
            systemAgents.forEach(systemAgent => {
                otherAgents.forEach(otherAgent => {
                    createEdge(systemAgent.id, otherAgent.id);
                });
            });
        }
        
        // Create edge between two nodes
        function createEdge(fromId, toId) {
            const fromNode = document.getElementById(`node-${fromId}`);
            const toNode = document.getElementById(`node-${toId}`);
            
            if (!fromNode || !toNode || !graphVisualization) return;
            
            // Get positions
            const fromRect = fromNode.getBoundingClientRect();
            const toRect = toNode.getBoundingClientRect();
            const containerRect = graphVisualization.getBoundingClientRect();
            
            // Calculate center points
            const fromCenterX = fromRect.left - containerRect.left + fromRect.width / 2;
            const fromCenterY = fromRect.top - containerRect.top + fromRect.height / 2;
            const toCenterX = toRect.left - containerRect.left + toRect.width / 2;
            const toCenterY = toRect.top - containerRect.top + toRect.height / 2;
            
            // Calculate length and angle
            const dX = toCenterX - fromCenterX;
            const dY = toCenterY - fromCenterY;
            const length = Math.sqrt(dX * dX + dY * dY);
            const angle = Math.atan2(dY, dX) * 180 / Math.PI;
            
            // Create edge
            const edge = document.createElement('div');
            edge.className = 'graph-edge';
            edge.style.width = `${length}px`;
            edge.style.height = '2px';
            edge.style.left = `${fromCenterX}px`;
            edge.style.top = `${fromCenterY}px`;
            edge.style.transform = `rotate(${angle}deg)`;
            
            graphVisualization.appendChild(edge);
        }
        
        // Create observability data for a message
        function createMessageObservability(messageId, agentName, content) {
            if (!agentName) return;
            
            // Find the agent
            const agent = agents.find(a => a.name === agentName);
            const guardrailsAgent = agents.find(a => a.name === 'Guardrails Agent');
            
            // Create observability container if not exists
            const observabilityTabs = document.getElementById('observabilityTabs');
            
            // Show the agent selection flow
            let agentSelectionHtml = '';
            
            if (guardrailsAgent && agent && guardrailsAgent.id !== agent.id) {
                agentSelectionHtml = `
                    <div class="agent-selection-flow">
                        <div class="agent-node selected">
                            <div class="agent-icon">
                                <i class="bi bi-shield-check"></i>
                            </div>
                            <div class="agent-info">
                                <div class="agent-name">Guardrails Agent</div>
                                <div class="agent-description small">Safety validation passed</div>
                            </div>
                        </div>
                        <div class="flow-arrow">→</div>
                        <div class="agent-node selected">
                            <div class="agent-icon">
                                <i class="bi bi-chat-dots"></i>
                            </div>
                            <div class="agent-info">
                                <div class="agent-name">${agentName}</div>
                                <div class="agent-description small">Matched intent pattern</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                agentSelectionHtml = `
                    <div class="agent-selection-flow">
                        <div class="agent-node selected">
                            <div class="agent-icon">
                                <i class="bi bi-chat-dots"></i>
                            </div>
                            <div class="agent-info">
                                <div class="agent-name">${agentName}</div>
                                <div class="agent-description small">Primary agent</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Add log
            addLog(`Message processed by ${agentName}`);
            
            // Add to timeline
            addTimelineEvent(`Agent ${agentName} selected for response`, 'System');
        }
        
        // Show observability details for a specific message
        function showMessageObservability(messageId) {
            // Highlight the selected message
            document.querySelectorAll('.message').forEach(msg => {
                msg.classList.remove('selected');
            });
            
            const selectedMessage = document.querySelector(`[data-message-id="${messageId}"]`);
            if (selectedMessage) {
                selectedMessage.classList.add('selected');
                
                // Get the agent name
                const agentBadge = selectedMessage.querySelector('.agent-badge .badge');
                if (agentBadge) {
                    const agentName = agentBadge.textContent;
                    
                    // Add to log
                    addLog(`Viewing details for message from ${agentName}`);
                    
                    // Switch to agents tab in observability panel
                    const agentsTab = document.getElementById('agents-tab');
                    if (agentsTab) {
                        const tab = new bootstrap.Tab(agentsTab);
                        tab.show();
                    }
                    
                    // Highlight the agent card
                    updateAgentStatus(agentName);
                }
            }
        }
        
        // Clear logs button handler
        document.getElementById('clear-logs')?.addEventListener('click', () => {
            if (logsContent) {
                logsContent.innerHTML = '';
                addLog('Logs cleared');
            }
        });
        
        // Clear timeline button handler
        document.getElementById('clear-timeline')?.addEventListener('click', () => {
            if (eventTimeline) {
                eventTimeline.innerHTML = '';
                addTimelineEvent('Timeline cleared', 'System', 'system');
            }
        });
        
        // Handle timeline to agent linking
        document.getElementById('timeline-to-agent')?.addEventListener('click', () => {
            // Find any selected timeline item
            const selectedItem = document.querySelector('.timeline-item.selected');
            if (selectedItem) {
                // Extract the agent name from the badge if present
                const badge = selectedItem.querySelector('.badge');
                if (badge && agents.find(a => a.name === badge.textContent)) {
                    // Show the agents tab and highlight the agent
                    const agentsTab = document.getElementById('agents-tab');
                    if (agentsTab) {
                        const tab = new bootstrap.Tab(agentsTab);
                        tab.show();
                        updateAgentStatus(badge.textContent);
                        addLog(`Linked timeline event to agent: ${badge.textContent}`);
                    }
                } else {
                    addLog('No agent found to link with selected timeline event');
                }
            } else {
                addLog('Please select a timeline event first');
            }
        });
    </script>
</body>
</html>